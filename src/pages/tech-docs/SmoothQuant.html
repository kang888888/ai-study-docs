<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmoothQuant：激活-权重协同平滑量化</title>
    <script>
        window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']] }, options: { skipHtmlTags: ['script','noscript','style','textarea','pre','code'] } };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    
    <!-- 公共样式 -->
    <link rel="stylesheet" href="../common/styles.css">
</head>
<body>
    <div class="container">
        <h1>SmoothQuant：平滑激活的联合量化</h1>
        <p class="tagline">通过在推理前将大幅度激活迁移到权重中，实现激活/权重量化的协同优化，显著降低 outlier 的影响。</p>

        <div class="meta-grid">
            <div class="meta-card"><h3>适用场景</h3><p>Transformer 推理、KV Cache 量化、混合位宽部署。</p></div>
            <div class="meta-card"><h3>优势</h3><p>无需训练、只需一次前向扫描、兼容 INT8/INT4。</p></div>
            <div class="meta-card"><h3>核心操作</h3><p>平滑系数 $calpha$、权重重缩放、激活再量化。</p></div>
            <div class="meta-card"><h3>生态</h3><p>已集成到 TensorRT-LLM、vLLM、ONNXRuntime。</p></div>
        </div>

        <div class="section">
            <h2>🌱 技术要点</h2>
            <ul>
                <li><strong>激活平滑：</strong>对每个通道选择 $\alpha_i \in [0,1]$，将激活峰值 "搬" 到权重。</li>
                <li><strong>权重补偿：</strong>$W'_i = W_i / \alpha_i$，激活变为 $A'_i = A_i \alpha_i$。</li>
                <li><strong>混合位宽：</strong>可将权重量化为 INT8、激活量化为 INT8/INT4，兼顾吞吐与精度。</li>
                <li><strong>通道自适应：</strong>通过搜索/贪心方式决定每个通道的 $\alpha_i$。</li>
            </ul>
        </div>

        <div class="section">
            <h2>📊 图解</h2>
            <div class="diagram-gallery">
                <div class="diagram-item"><img src="./assets/SmoothQuant流程.png" alt="平滑流程" onclick="openImageModal(this)" onerror="this.parentElement.style.display='none'"><div class="caption">平滑流程</div></div>
                <div class="diagram-item"><img src="./assets/SmoothQuant激活.png" alt="激活分布变化" onclick="openImageModal(this)" onerror="this.parentElement.style.display='none'"><div class="caption">激活分布变化</div></div>
                <div class="diagram-item"><img src="./assets/SmoothQuant矩阵.png" alt="矩阵重缩放" onclick="openImageModal(this)" onerror="this.parentElement.style.display='none'"><div class="caption">矩阵重缩放</div></div>
            </div>
        </div>

        <div class="section">
            <h2>📐 数学原理</h2>
            <div class="math-box">
                <h3>平滑变换</h3>
                <div class="math-formula">
                    <p>$$W' = W D^{-1}, \quad A' = D A$$</p>
                    <p>$D = \text{diag}(\alpha_1, ..., \alpha_n)$，使得 $\max(|A'|)$ 更小。</p>
                </div>
            </div>
            <div class="math-box">
                <h3>选择 $\alpha$</h3>
                <div class="math-formula">
                    <p>目标：$$\alpha_i = \arg\min_{\alpha \in [0,1]} \left( \lambda \cdot \|A_i \alpha\|_{\infty} + (1-\lambda) \cdot \|W_i / \alpha\|_{\infty} \right)$$</p>
                    <p>在实践中通常通过网格搜索或贪心近似。</p>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>💻 代码示例</h2>
            <div class="code-box">
                <h3>在 TensorRT-LLM 中启用 SmoothQuant</h3>
                <pre><code class="language-python">from tensorrt_llm.quantization import smooth_quantize

engine = smooth_quantize(
    onnx_path="llama2.onnx",
    calib_data="calib_texts.txt",
    act_bits=8,
    weight_bits=8,
    alpha=0.5,
    per_channel=True
)
engine.save("./llama2_smoothquant.plan")
</code></pre>
            </div>
        </div>
    </div>

    <div id="imageModal" class="image-modal" onclick="closeImageModal()">
        <span class="image-modal-close" onclick="event.stopPropagation(); closeImageModal();">&times;</span>
        <img id="modalImage" class="image-modal-content" src="" alt="">
        <div id="modalCaption" class="image-modal-caption"></div>
    </div>

    <script>
        function openImageModal(img){const modal=document.getElementById('imageModal');modal.classList.add('active');document.getElementById('modalImage').src=img.src;document.getElementById('modalCaption').textContent=img.alt||'';}
        function closeImageModal(){document.getElementById('imageModal').classList.remove('active');}
        document.addEventListener('keydown',e=>{if(e.key==='Escape')closeImageModal();});
    </script>
    <!-- 公共脚本 -->
    <script src="../common/tech-document.js"></script>
</body>
</html>
