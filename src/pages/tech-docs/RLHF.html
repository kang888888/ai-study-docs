<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RLHFï¼ˆReinforcement Learning from Human Feedbackï¼‰- æŠ€æœ¯è¯¦è§£</title>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    
    <!-- å…¬å…±æ ·å¼ -->
    <link rel="stylesheet" href="../common/styles.css">
</head>
<body>
    <div class="container">
        <h1>RLHFï¼šåŸºäºäººç±»åé¦ˆçš„å¼ºåŒ–å­¦ä¹ å¾®è°ƒ</h1>
        <p class="tagline">é€šè¿‡â€œåå¥½æ•°æ® â†’ å¥–åŠ±æ¨¡å‹ â†’ PPO å¾®è°ƒâ€ä¸‰é˜¶æ®µæµç¨‹ï¼Œè®©å¤§æ¨¡å‹åœ¨å®‰å…¨æ€§ã€æœ‰ç”¨æ€§å’Œç¤¼è²Œæ€§ä¸Šä¸äººç±»æœŸæœ›å¯¹é½ã€‚</p>

        <div class="meta-grid">
            <div class="meta-card">
                <h3>ä¸‰é˜¶æ®µæµç¨‹</h3>
                <p>SFT ç›‘ç£èµ·ç‚¹ â†’ å¥–åŠ±æ¨¡å‹è®­ç»ƒ â†’ PPO / DPO å¼ºåŒ–å­¦ä¹ ï¼Œé€æ­¥æå‡å¯¹é½è´¨é‡ã€‚</p>
            </div>
            <div class="meta-card">
                <h3>æ•°æ®éœ€æ±‚</h3>
                <p>æˆå¯¹åå¥½æ ‡æ³¨ï¼ˆChosen vs Rejectedï¼‰ã€å®‰å…¨å®¡æŸ¥æ ‡ç­¾ã€å¯¹è¯æ—¥å¿—ã€‚</p>
            </div>
            <div class="meta-card">
                <h3>å…¸å‹å·¥å…·</h3>
                <p>TRL (PPOTrainer), DeepSpeed ZeRO, OpenAI Evals, human-in-the-loop å¹³å°ã€‚</p>
            </div>
            <div class="meta-card">
                <h3>é€‚ç”¨èŒƒå›´</h3>
                <p>å¯¹è¯åŠ©æ‰‹ã€ä»£ç åŠ©æ‰‹ã€æœç´¢é—®ç­”ã€éœ€è¦å®‰å…¨ç­–ç•¥çš„å¤æ‚ä»»åŠ¡ã€‚</p>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ§  æŠ€æœ¯è¦ç‚¹</h2>
            <ul>
                <li><strong>å¥–åŠ±å»ºæ¨¡ï¼š</strong>ä½¿ç”¨æˆå¯¹æ•°æ®è®­ç»ƒ $r_\phi(x,y)$ï¼Œæ•æ‰äººç±»åå¥½æ’åºã€‚</li>
                <li><strong>PPO å¯¹é½ï¼š</strong>åœ¨ KL æƒ©ç½šä¸‹ä¼˜åŒ–ç­–ç•¥ $\pi_\theta$ï¼Œç¡®ä¿è¾“å‡ºä¸åç¦» SFT åŸºçº¿ã€‚</li>
                <li><strong>å®‰å…¨ç­–ç•¥ï¼š</strong>èåˆæ‹’ç­”ã€è¯é¢˜è½¬ç§»ã€çº¢çº¿æ£€æµ‹ç­‰è§„åˆ™ï¼Œå½¢æˆç»„åˆå¥–åŠ±ã€‚</li>
                <li><strong>åœ¨çº¿äººç±»å›è·¯ï¼š</strong>é€šè¿‡ä¸»åŠ¨å­¦ä¹ è·å–éš¾ä¾‹ï¼Œè¿­ä»£æå‡å¥–åŠ±æ¨¡å‹è¦†ç›–é¢ã€‚</li>
            </ul>
        </div>

        <div class="section">
            <h2>ğŸ“Š æ¶æ„å›¾è§£</h2>
            <div class="diagram-gallery">
                <div class="diagram-item">
                    <img src="./assets/RLHFæµç¨‹.png" alt="RLHF ä¸‰é˜¶æ®µæµç¨‹" onclick="openImageModal(this)" onerror="this.parentElement.style.display='none'">
                    <div class="caption">ä¸‰é˜¶æ®µæµç¨‹</div>
                </div>
                <div class="diagram-item">
                    <img src="./assets/å¥–åŠ±æ¨¡å‹ç»“æ„.png" alt="å¥–åŠ±æ¨¡å‹ç»“æ„" onclick="openImageModal(this)" onerror="this.parentElement.style.display='none'">
                    <div class="caption">å¥–åŠ±æ¨¡å‹ç»“æ„</div>
                </div>
                <div class="diagram-item">
                    <img src="./assets/PPOè®­ç»ƒæ›²çº¿.png" alt="PPO è®­ç»ƒæ›²çº¿" onclick="openImageModal(this)" onerror="this.parentElement.style.display='none'">
                    <div class="caption">PPO è®­ç»ƒæ›²çº¿</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ“ æ•°å­¦åŸç†</h2>
            <div class="math-box">
                <h3>å¥–åŠ±æ¨¡å‹</h3>
                <div class="math-formula">
                    <p>ä½¿ç”¨ Bradley-Terry æŸå¤±ï¼š</p>
                    <p>$$\mathcal{L}_{\text{RM}} = -\log \sigma(r_\phi(x, y^{+}) - r_\phi(x, y^{-}))$$</p>
                    <p>é¼“åŠ±æ¨¡å‹ä¸ºæ›´ä¼˜å›ç­”ç»™å‡ºæ›´é«˜è¯„åˆ†ã€‚</p>
                </div>
            </div>
            <div class="math-box">
                <h3>PPO ç›®æ ‡</h3>
                <div class="math-formula">
                    <p>ç­–ç•¥æ›´æ–°ç›®æ ‡ï¼š</p>
                    <p>$$\max_\theta \mathbb{E}\left[ \min\left( \rho_t(\theta) A_t, \operatorname{clip}(\rho_t(\theta), 1-\epsilon, 1+\epsilon) A_t \right) - \beta \cdot KL(\pi_\theta || \pi_{\text{SFT}}) \right]$$</p>
                    <p>å…¶ä¸­ $A_t$ ç”±å¥–åŠ± - åŸºå‡†ç»„æˆï¼Œ$\beta$ æ§åˆ¶ä¸ SFT æ¨¡å‹çš„åç¦»ç¨‹åº¦ã€‚</p>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ’» Python ä»£ç ç¤ºä¾‹</h2>
            <div class="code-box">
                <h3>ä½¿ç”¨ TRL è¿›è¡Œ PPO å¾®è°ƒ</h3>
                <pre><code class="language-python">from trl import PPOTrainer, PPOConfig, AutoModelForCausalLMWithValueHead
from transformers import AutoTokenizer

config = PPOConfig(
    model_name="meta-llama/Llama-2-7b-hf",
    learning_rate=1e-5,
    batch_size=64,
    ppo_epochs=4,
    kl_penalty=0.1
)

tokenizer = AutoTokenizer.from_pretrained(config.model_name)
model = AutoModelForCausalLMWithValueHead.from_pretrained(
    config.model_name,
    load_in_4bit=True,
    device_map="auto"
)

ppo_trainer = PPOTrainer(
    config,
    model,
    tokenizer,
    dataset=rlhf_dataset  # åŒ…å« prompt / chosen / rejected
)

for batch in ppo_trainer.dataloader:
    query_tensors = batch["input_ids"]
    response_tensors = ppo_trainer.generate(query_tensors)
    rewards = reward_model(query_tensors, response_tensors)
    ppo_trainer.step(query_tensors, response_tensors, rewards)
</code></pre>
            </div>
        </div>
    </div>

    <div id="imageModal" class="image-modal" onclick="closeImageModal()">
        <span class="image-modal-close" onclick="event.stopPropagation(); closeImageModal();">&times;</span>
        <img id="modalImage" class="image-modal-content" src="" alt="">
        <div id="modalCaption" class="image-modal-caption"></div>
    </div>

    <script>
        function openImageModal(img) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            const modalCaption = document.getElementById('modalCaption');
            modal.classList.add('active');
            modalImg.src = img.src;
            modalCaption.textContent = img.alt || '';
        }
        function closeImageModal() {
            document.getElementById('imageModal').classList.remove('active');
        }
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeImageModal();
        });
    </script>
    <!-- å…¬å…±è„šæœ¬ -->
    <script src="../common/tech-document.js"></script>
</body>
</html>
