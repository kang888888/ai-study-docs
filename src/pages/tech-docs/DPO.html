<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DPOï¼ˆDirect Preference Optimizationï¼‰- æŠ€æœ¯è¯¦è§£</title>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    
    <!-- å…¬å…±æ ·å¼ -->
    <link rel="stylesheet" href="../common/styles.css">
</head>
<body>
    <div class="container">
        <h1>DPOï¼šæ— éœ€å¥–åŠ±æ¨¡å‹çš„ç›´æ¥åå¥½ä¼˜åŒ–</h1>
        <p class="tagline">é€šè¿‡è§£æåå¥½æ•°æ®çš„å¯¹æ•°ä¼¼ç„¶å·®ï¼Œç›´æ¥åœ¨ç­–ç•¥ç©ºé—´ä¸­é€¼è¿‘äººç±»åå¥½ï¼Œé¿å…è®­ç»ƒé¢å¤–å¥–åŠ±æ¨¡å‹å’Œ RL loopã€‚</p>

        <div class="meta-grid">
            <div class="meta-card">
                <h3>æ ¸å¿ƒç‰¹æ€§</h3>
                <p>ç›´æ¥æœ€å°åŒ– KL æ­£åˆ™åŒ–çš„åå¥½æŸå¤±ï¼Œè®­ç»ƒç¨³å®šã€å®ç°ç®€å•ã€æ— éœ€ PPOã€‚</p>
            </div>
            <div class="meta-card">
                <h3>æ•°æ®éœ€æ±‚</h3>
                <p>ä¸ RLHF ç›¸åŒçš„ Chosen/Rejected æˆå¯¹æ ·æœ¬æˆ–æ’åºæ ·æœ¬ã€‚</p>
            </div>
            <div class="meta-card">
                <h3>æ¶æ„å…¼å®¹</h3>
                <p>é€‚ç”¨äºä»»ä½•è‡ªå›å½’å¤§æ¨¡å‹ï¼Œå¯æ­é… LoRA/QLoRA å‡å°‘æˆæœ¬ã€‚</p>
            </div>
            <div class="meta-card">
                <h3>å…¸å‹å·¥å…·</h3>
                <p>TRL DPOTrainerã€AlignProã€LLaMA-Factoryã€Axolotl DPO presetã€‚</p>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ§© æŠ€æœ¯è¦ç‚¹</h2>
            <ul>
                <li><strong>æ— å¥–åŠ±æ¨¡å‹ï¼š</strong>ç›´æ¥ä½¿ç”¨åŸºå‡†ç­–ç•¥ï¼ˆSFT æ¨¡å‹ï¼‰å¯¹ä¼˜åŠ£å›ç­”çš„å¯¹æ•°æ¦‚ç‡å·®è¿›è¡Œå¯¹æ¯”å­¦ä¹ ã€‚</li>
                <li><strong>å¯è°ƒæ¸©åº¦ï¼š</strong>è¶…å‚æ•° $\beta$ æ§åˆ¶å­¦ä¹ åŠ›åº¦ï¼Œè¾ƒå°å€¼æ›´ä¿å®ˆï¼Œè¾ƒå¤§å€¼æ›´æ¥è¿‘åå¥½ã€‚</li>
                <li><strong>é«˜å¹¶è¡Œæ•ˆç‡ï¼š</strong>ä»…éœ€ä¸¤æ¬¡å‰å‘ï¼ˆchosen/rejectedï¼‰ï¼Œå¯ä½¿ç”¨å¸¸è§„ SFT æ¡†æ¶åŠ é€Ÿã€‚</li>
                <li><strong>å…¼å®¹ RL è¯„ä¼°ï¼š</strong>å¯ä¸ reward model è”åˆä½¿ç”¨è¿›è¡Œç¦»çº¿è¯„ä¼°ä¸å®‰å…¨å®¡æŸ¥ã€‚</li>
            </ul>
        </div>

        <div class="section">
            <h2>ğŸ“Š å›¾è§£</h2>
            <div class="diagram-gallery">
                <div class="diagram-item">
                    <img src="./assets/DPOæµç¨‹.png" alt="DPO è®­ç»ƒæµç¨‹" onclick="openImageModal(this)" onerror="this.parentElement.style.display='none'">
                    <div class="caption">è®­ç»ƒæµç¨‹</div>
                </div>
                <div class="diagram-item">
                    <img src="./assets/DPOæŸå¤±.png" alt="æŸå¤±æ›²çº¿" onclick="openImageModal(this)" onerror="this.parentElement.style.display='none'">
                    <div class="caption">æŸå¤±æ›²çº¿</div>
                </div>
                <div class="diagram-item">
                    <img src="./assets/DPOå¯¹æ¯”.png" alt="ä¸ PPO å¯¹æ¯”" onclick="openImageModal(this)" onerror="this.parentElement.style.display='none'">
                    <div class="caption">ä¸ PPO å¯¹æ¯”</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ“ æ•°å­¦åŸç†</h2>
            <div class="math-box">
                <h3>åå¥½æŸå¤±</h3>
                <div class="math-formula">
                    <p>DPO å°†åå¥½å»ºæ¨¡ä¸ºï¼š</p>
                    <p>$$\mathcal{L}_{\text{DPO}} = - \log \sigma\Big( \beta(\log \pi_\theta(y^{+}|x) - \log \pi_\theta(y^{-}|x)) - (\log \pi_{\text{ref}}(y^{+}|x) - \log \pi_{\text{ref}}(y^{-}|x)) \Big)$$</p>
                    <p>å…¶ä¸­ $\pi_{\text{ref}}$ ä¸ºåŸºå‡†æ¨¡å‹ï¼Œ$\beta$ ä¸ºæ¸©åº¦ç³»æ•°ã€‚</p>
                </div>
            </div>
            <div class="math-box">
                <h3>æ¢¯åº¦æ€§è´¨</h3>
                <div class="math-formula">
                    <p>æ¢¯åº¦ä¸åå¥½å·®æˆæ­£æ¯”ï¼š</p>
                    <p>$$\nabla_\theta \mathcal{L} \propto (1 - \sigma(\cdot)) \cdot \nabla_\theta \big( \log \pi_\theta(y^{+}|x) - \log \pi_\theta(y^{-}|x) \big)$$</p>
                    <p>è®­ç»ƒç¨³å®šä¸”å¯ç›´æ¥ä¸å¸¸è§„ä¼˜åŒ–å™¨ç»“åˆã€‚</p>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ’» Python ä»£ç ç¤ºä¾‹</h2>
            <div class="code-box">
                <h3>ä½¿ç”¨ TRL DPOTrainer</h3>
                <pre><code class="language-python">from trl import DPOTrainer, DPOConfig
from transformers import AutoTokenizer, AutoModelForCausalLM

dpo_config = DPOConfig(
    model_name_or_path="meta-llama/Llama-2-7b-hf",
    ref_model_name_or_path="meta-llama/Llama-2-7b-hf",
    beta=0.1,
    per_device_train_batch_size=2,
    gradient_accumulation_steps=8,
    learning_rate=5e-6
)

tokenizer = AutoTokenizer.from_pretrained(dpo_config.model_name_or_path)
model = AutoModelForCausalLM.from_pretrained(dpo_config.model_name_or_path, load_in_8bit=True, device_map="auto")
ref_model = AutoModelForCausalLM.from_pretrained(dpo_config.ref_model_name_or_path, load_in_8bit=True, device_map="auto")

dpo_trainer = DPOTrainer(
    model,
    ref_model,
    tokenizer=tokenizer,
    args=dpo_config,
    beta=dpo_config.beta,
    train_dataset=preference_dataset
)

dpo_trainer.train()
</code></pre>
            </div>
        </div>
    </div>

    <div id="imageModal" class="image-modal" onclick="closeImageModal()">
        <span class="image-modal-close" onclick="event.stopPropagation(); closeImageModal();">&times;</span>
        <img id="modalImage" class="image-modal-content" src="" alt="">
        <div id="modalCaption" class="image-modal-caption"></div>
    </div>

    <script>
        function openImageModal(img) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            const modalCaption = document.getElementById('modalCaption');
            modal.classList.add('active');
            modalImg.src = img.src;
            modalCaption.textContent = img.alt || '';
        }
        function closeImageModal() {
            document.getElementById('imageModal').classList.remove('active');
        }
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeImageModal();
        });
    </script>
    <!-- å…¬å…±è„šæœ¬ -->
    <script src="../common/tech-document.js"></script>
</body>
</html>
