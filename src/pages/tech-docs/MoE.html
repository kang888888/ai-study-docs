<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoE (Mixture of Experts) æ··åˆä¸“å®¶æ¨¡å‹ - æ¶æ„è¯¦è§£</title>
    <!-- MathJax for mathematical formulas -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- Prism.js for code highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    
    <!-- å…¬å…±æ ·å¼ -->
    <link rel="stylesheet" href="../common/styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>MoE (Mixture of Experts) æ··åˆä¸“å®¶æ¨¡å‹</h1>
            <p>ç¨€ç–æ¿€æ´»çš„è¶…å¤§è§„æ¨¡æ¨¡å‹æ¶æ„</p>
        </div>
        <div class="content">
            
            <div class="section">
                <h2>ğŸ“– æ ¸å¿ƒæ¦‚å¿µ</h2>
                <div class="desc-box">
                    <p>å°†å¤§æ¨¡å‹æ‹†åˆ†ä¸ºå¤šä¸ª'ä¸“å®¶'å­ç½‘ç»œï¼ˆé€šå¸¸æ˜¯FFNå±‚ï¼‰ï¼Œé€šè¿‡é—¨æ§ç½‘ç»œï¼ˆRouter/Gating Networkï¼‰åŠ¨æ€é€‰æ‹©æ¿€æ´»å“ªäº›ä¸“å®¶ã€‚å®ç°äº†å‚æ•°æ€»é‡å¤§ä½†è®¡ç®—é‡å°çš„ç¨€ç–æ¿€æ´»ã€‚</p>
                </div>
            </div>
            <div class="section features">
                <h2>ğŸŒŸ æ ¸å¿ƒç‰¹ç‚¹</h2>
                <ul>
                    <li>ç¨€ç–æ¿€æ´»ï¼šæ¯æ¬¡æ¨ç†åªæ¿€æ´»éƒ¨åˆ†ä¸“å®¶ï¼ˆå¦‚Top-2ï¼‰ï¼Œè®¡ç®—é‡å¤§å¹…é™ä½</li>
                    <li>å‚æ•°æ•ˆç‡ï¼šæ€»å‚æ•°é‡å¯è¾¾æ•°åƒäº¿ï¼Œä½†æ¿€æ´»å‚æ•°ä»…æ•°åäº¿</li>
                    <li>é—¨æ§è·¯ç”±ï¼šå¯å­¦ä¹ çš„Routerå†³å®šè¾“å…¥åº”è¯¥äº¤ç»™å“ªäº›ä¸“å®¶å¤„ç†</li>
                    <li>è´Ÿè½½å‡è¡¡ï¼šé€šè¿‡è¾…åŠ©æŸå¤±å‡½æ•°ç¡®ä¿ä¸“å®¶è´Ÿè½½å‡è¡¡</li>
                    <li>æè‡´æ€§ä»·æ¯”ï¼šMixtral 8x7Bæ€§èƒ½åª²ç¾LLaMA-70Bï¼Œä½†æ¨ç†æˆæœ¬ä»…ä¸º13B</li>
                </ul>
            </div>
            <div class="section">
                <h2>âš™ï¸ å…³é”®æŠ€æœ¯</h2>
                <div class="tech-box"><p><strong>é—¨æ§ç½‘ç»œï¼ˆGating Networkï¼‰ã€Top-Kè·¯ç”±ã€è´Ÿè½½å‡è¡¡æŸå¤±ï¼ˆAuxiliary Lossï¼‰ã€ä¸“å®¶å¹¶è¡Œ</strong></p></div>
            </div>
            <div class="section">
                <h2>ğŸš€ åº”ç”¨åœºæ™¯</h2>
                <div class="app-box"><p>è¶…å¤§è§„æ¨¡è¯­è¨€æ¨¡å‹ï¼ˆDeepSeek-V2/V3ã€Mixtralã€GPT-4æ¨æµ‹ï¼‰ã€å¤šä»»åŠ¡å­¦ä¹ </p></div>
            </div>
            <div class="section">
                <h2>ğŸ“Š æ¶æ„å›¾è§£</h2>
                <div class="diagram-gallery">
                    <div class="diagram-item"><img src="MoE_Routing_Visualization.png" alt="MoEè·¯ç”±å¯è§†åŒ–" onclick="openImageModal(this)" onerror="this.parentElement.style.display='none'"><div class="caption">MoEè·¯ç”±å¯è§†åŒ–</div></div>
                </div>
            </div>

            <div class="section">
                <h2>ğŸ“ æ•°å­¦åŸç†</h2>
                <div class="math-box">
                    <h3>é—¨æ§ç½‘ç»œï¼ˆGating Networkï¼‰</h3>
                    <div class="math-formula">
                        <p>é—¨æ§ç½‘ç»œè®¡ç®—æ¯ä¸ªä¸“å®¶çš„æƒé‡ï¼š</p>
                        <p>$$G(x) = \text{softmax}(W_g x + b_g)$$</p>
                        <p>å…¶ä¸­ $G(x) \in \mathbb{R}^E$ï¼Œ$E$ æ˜¯ä¸“å®¶æ•°é‡</p>
                    </div>
                </div>
                <div class="math-box">
                    <h3>Top-K è·¯ç”±</h3>
                    <div class="math-formula">
                        <p>é€‰æ‹©Top-Kä¸ªä¸“å®¶ï¼š</p>
                        <p>$$\text{TopK}(G(x), k) = \{i_1, i_2, ..., i_k\}$$</p>
                        <p>è¾“å‡ºä¸ºé€‰ä¸­ä¸“å®¶çš„åŠ æƒå’Œï¼š</p>
                        <p>$$y = \sum_{i \in \text{TopK}} G_i(x) \cdot E_i(x)$$</p>
                        <p>å…¶ä¸­ $E_i(x)$ æ˜¯ç¬¬ $i$ ä¸ªä¸“å®¶çš„è¾“å‡º</p>
                    </div>
                </div>
                <div class="math-box">
                    <h3>è´Ÿè½½å‡è¡¡æŸå¤±</h3>
                    <div class="math-formula">
                        <p>ç¡®ä¿ä¸“å®¶è´Ÿè½½å‡è¡¡ï¼š</p>
                        <p>$$L_{aux} = \alpha \cdot \sum_{i=1}^{E} f_i \cdot P_i$$</p>
                        <p>å…¶ä¸­ $f_i$ æ˜¯ä¸“å®¶ $i$ è¢«é€‰ä¸­çš„é¢‘ç‡ï¼Œ$P_i$ æ˜¯å¹³å‡è·¯ç”±æ¦‚ç‡</p>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>ğŸ’» Python ä»£ç ç¤ºä¾‹</h2>
                <div class="code-box">
                    <h3>ä½¿ç”¨ PyTorch å®ç° MoE å±‚</h3>
                    <pre><code class="language-python">import torch
import torch.nn as nn
import torch.nn.functional as F

class MoELayer(nn.Module):
    """æ··åˆä¸“å®¶å±‚"""
    def __init__(self, d_model, num_experts=8, top_k=2):
        super(MoELayer, self).__init__()
        self.num_experts = num_experts
        self.top_k = top_k
        
        # é—¨æ§ç½‘ç»œ
        self.gate = nn.Linear(d_model, num_experts)
        
        # å¤šä¸ªä¸“å®¶ï¼ˆFFNï¼‰
        self.experts = nn.ModuleList([
            nn.Sequential(
                nn.Linear(d_model, d_model * 4),
                nn.ReLU(),
                nn.Linear(d_model * 4, d_model)
            ) for _ in range(num_experts)
        ])
    
    def forward(self, x):
        """
        å‚æ•°:
            x: [batch_size, seq_length, d_model]
        è¿”å›:
            output: [batch_size, seq_length, d_model]
        """
        batch_size, seq_length, d_model = x.shape
        
        # è®¡ç®—é—¨æ§æƒé‡
        gate_logits = self.gate(x)  # [batch_size, seq_length, num_experts]
        gate_probs = F.softmax(gate_logits, dim=-1)
        
        # Top-K é€‰æ‹©
        top_k_probs, top_k_indices = torch.topk(gate_probs, self.top_k, dim=-1)
        top_k_probs = top_k_probs / top_k_probs.sum(dim=-1, keepdim=True)
        
        # åˆå§‹åŒ–è¾“å‡º
        output = torch.zeros_like(x)
        
        # å¯¹æ¯ä¸ªä¸“å®¶è®¡ç®—è¾“å‡º
        for i in range(self.num_experts):
            # æ‰¾åˆ°ä½¿ç”¨å½“å‰ä¸“å®¶çš„ä½ç½®
            expert_mask = (top_k_indices == i)
            
            if expert_mask.any():
                # è®¡ç®—ä¸“å®¶è¾“å‡º
                expert_output = self.experts[i](x)
                
                # åŠ æƒç´¯åŠ 
                weights = top_k_probs * expert_mask.float()
                output += weights.unsqueeze(-1) * expert_output
        
        return output

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    moe = MoELayer(d_model=512, num_experts=8, top_k=2)
    x = torch.randn(2, 100, 512)
    output = moe(x)
    print(f"è¾“å‡ºå½¢çŠ¶: {output.shape}")  # [2, 100, 512]</code></pre>
                </div>
            </div>
        </div>
    </div>
    <!-- å›¾ç‰‡æ”¾å¤§å¼¹çª— -->
    <div id="imageModal" class="image-modal" onclick="closeImageModal()">
        <span class="image-modal-close" onclick="event.stopPropagation(); closeImageModal()">&times;</span>
        <img id="modalImage" class="image-modal-content" src="" alt="">
        <div id="modalCaption" class="image-modal-caption"></div>
    </div>
    <script>
        function openImageModal(img) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            const modalCaption = document.getElementById('modalCaption');
            modal.classList.add('active');
            modalImg.src = img.src;
            modalCaption.textContent = img.alt || '';
            modalImg.onclick = function(e) { e.stopPropagation(); };
        }
        function closeImageModal() {
            document.getElementById('imageModal').classList.remove('active');
        }
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeImageModal();
        });
    </script>
    <!-- å…¬å…±è„šæœ¬ -->
    <script src="../common/tech-document.js"></script>
</body>
</html>

