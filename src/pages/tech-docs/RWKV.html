<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RWKV (Receptance Weighted Key Value) - æ¶æ„è¯¦è§£</title>
    <!-- MathJax for mathematical formulas -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- Prism.js for code highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    
    <!-- å…¬å…±æ ·å¼ -->
    <link rel="stylesheet" href="../common/styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>RWKV (Receptance Weighted Key Value)</h1>
            <p>ç»“åˆTransformerå’ŒRNNä¼˜åŠ¿çš„åˆ›æ–°æ¶æ„</p>
        </div>
        <div class="content">
            
            <div class="section">
                <h2>ğŸ“– æ ¸å¿ƒæ¦‚å¿µ</h2>
                <div class="desc-box">
                    <p>ä¸€ç§åˆ›æ–°æ¶æ„ï¼Œç»“åˆäº†Transformerçš„å¹¶è¡Œè®­ç»ƒèƒ½åŠ›å’ŒRNNçš„é«˜æ•ˆæ¨ç†ç‰¹æ€§ã€‚é€šè¿‡çº¿æ€§æ³¨æ„åŠ›æœºåˆ¶ï¼Œå®ç°O(L)å¤æ‚åº¦çš„åŒæ—¶ä¿æŒæ¥è¿‘Transformerçš„æ€§èƒ½ã€‚</p>
                </div>
            </div>
            <div class="section features">
                <h2>ğŸŒŸ æ ¸å¿ƒç‰¹ç‚¹</h2>
                <ul>
                    <li>çº¿æ€§Attentionï¼šå°†æ ‡å‡†Attentionæ”¹é€ ä¸ºçº¿æ€§é€’å½’å½¢å¼</li>
                    <li>åŒé‡æ¨¡å¼ï¼šè®­ç»ƒæ—¶å¹¶è¡Œï¼ˆç±»ä¼¼Transformerï¼‰ï¼Œæ¨ç†æ—¶é€’å½’ï¼ˆç±»ä¼¼RNNï¼‰</li>
                    <li>æ˜¾å­˜é«˜æ•ˆï¼šæ¨ç†æ—¶æ˜¾å­˜å ç”¨O(1)ï¼Œæ— KV Cache</li>
                    <li>æ— é™ä¸Šä¸‹æ–‡ï¼šç†è®ºä¸Šå¯ä»¥å¤„ç†æ— é™é•¿çš„åºåˆ—</li>
                    <li>å¼€æºå‹å¥½ï¼šå®Œå…¨å¼€æºï¼Œç¤¾åŒºæ´»è·ƒ</li>
                </ul>
            </div>
            <div class="section">
                <h2>âš™ï¸ å…³é”®æŠ€æœ¯</h2>
                <div class="tech-box"><p><strong>Time-Mixingã€Channel-Mixingã€æŒ‡æ•°è¡°å‡æœºåˆ¶ã€å¹¶è¡Œå‰ç¼€å’Œç®—æ³•</strong></p></div>
            </div>
            <div class="section">
                <h2>ğŸš€ åº”ç”¨åœºæ™¯</h2>
                <div class="app-box"><p>é•¿æ–‡æœ¬ç”Ÿæˆã€å¯¹è¯ç³»ç»Ÿã€ä»£ç ç”Ÿæˆã€ä½èµ„æºåœºæ™¯éƒ¨ç½²</p></div>
            </div>
            <div class="section">
                <h2>ğŸ“Š æ¶æ„å›¾è§£</h2>
                <div class="diagram-gallery">
                    <div class="diagram-item"><img src="RWKV_Decay_Visualization.png" alt="RWKVè¡°å‡å¯è§†åŒ–" onclick="openImageModal(this)" onerror="this.parentElement.style.display='none'"><div class="caption">RWKVè¡°å‡å¯è§†åŒ–</div></div>
                </div>
            </div>

            <div class="section">
                <h2>ğŸ“ æ•°å­¦åŸç†</h2>
                <div class="math-box">
                    <h3>Time-Mixing</h3>
                    <div class="math-formula">
                        <p>RWKV çš„ Time-Mixing æœºåˆ¶ï¼š</p>
                        <p>$$r_t = W_r \cdot x_t$$</p>
                        <p>$$k_t = W_k \cdot x_t$$</p>
                        <p>$$v_t = W_v \cdot x_t$$</p>
                        <p>$$o_t = \sigma(r_t) \odot \frac{\sum_{i=1}^{t} w_{t-i} \cdot k_i \odot v_i}{\sum_{i=1}^{t} w_{t-i} \cdot k_i}$$</p>
                        <p>å…¶ä¸­ $w_{t-i}$ æ˜¯æ—¶é—´è¡°å‡æƒé‡</p>
                    </div>
                </div>
                <div class="math-box">
                    <h3>æŒ‡æ•°è¡°å‡æœºåˆ¶</h3>
                    <div class="math-formula">
                        <p>ä½¿ç”¨æŒ‡æ•°è¡°å‡æ¨¡æ‹Ÿæ³¨æ„åŠ›ï¼š</p>
                        <p>$$w_{t-i} = e^{-\alpha (t-i)}$$</p>
                        <p>å…¶ä¸­ $\alpha$ æ˜¯å¯å­¦ä¹ çš„è¡°å‡å‚æ•°ï¼Œä½¿å¾—è·ç¦»è¶Šè¿œçš„ä¿¡æ¯æƒé‡è¶Šå°</p>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>ğŸ’» Python ä»£ç ç¤ºä¾‹</h2>
                <div class="code-box">
                    <h3>ä½¿ç”¨ rwkv åº“åŠ è½½ RWKV æ¨¡å‹</h3>
                    <pre><code class="language-python">from rwkv.model import RWKV
from rwkv.utils import PIPELINE, PIPELINE_ARGS

# åŠ è½½æ¨¡å‹
model = RWKV(model='./RWKV-4-Pile-430M.pth', strategy='cuda fp32')
pipeline = PIPELINE(model, "20B_tokenizer.json")

# ç”Ÿæˆæ–‡æœ¬
text = "The future of AI is"
args = PIPELINE_ARGS(temperature=1.0, top_p=0.5)

output = pipeline.generate(text, token_count=100, args=args)
print(output)</code></pre>
                </div>
                <div class="code-box">
                    <h3>æ‰‹åŠ¨å®ç°ç®€åŒ–ç‰ˆ RWKV Time-Mixing</h3>
                    <pre><code class="language-python">import torch
import torch.nn as nn
import torch.nn.functional as F

class RWKVTimeMixing(nn.Module):
    """RWKV Time-Mixing å±‚ï¼ˆç®€åŒ–ç‰ˆï¼‰"""
    def __init__(self, d_model):
        super(RWKVTimeMixing, self).__init__()
        self.d_model = d_model
        
        # Receptance, Key, Value
        self.r = nn.Linear(d_model, d_model)
        self.k = nn.Linear(d_model, d_model)
        self.v = nn.Linear(d_model, d_model)
        
        # è¡°å‡å‚æ•°
        self.decay = nn.Parameter(torch.ones(d_model))
    
    def forward(self, x):
        """
        å‚æ•°:
            x: [batch_size, seq_length, d_model]
        è¿”å›:
            output: [batch_size, seq_length, d_model]
        """
        batch_size, seq_length, d_model = x.shape
        
        r = torch.sigmoid(self.r(x))
        k = self.k(x)
        v = self.v(x)
        
        # è®¡ç®—è¡°å‡æƒé‡
        decay_weights = torch.exp(-self.decay.unsqueeze(0).unsqueeze(0) * 
                                  torch.arange(seq_length, device=x.device).float().unsqueeze(-1))
        
        # é€’å½’è®¡ç®—ï¼ˆç®€åŒ–ç‰ˆï¼‰
        output = torch.zeros_like(x)
        for t in range(seq_length):
            # åŠ æƒèšåˆå†å²ä¿¡æ¯
            weights = decay_weights[:t+1].flip(0)  # åè½¬ï¼Œæœ€è¿‘çš„æƒé‡æœ€å¤§
            weighted_kv = (weights.unsqueeze(-1) * k[:, :t+1, :] * v[:, :t+1, :]).sum(dim=1)
            weighted_k = (weights.unsqueeze(-1) * k[:, :t+1, :]).sum(dim=1)
            
            output[:, t, :] = r[:, t, :] * (weighted_kv / (weighted_k + 1e-8))
        
        return output

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    model = RWKVTimeMixing(d_model=512)
    x = torch.randn(2, 100, 512)
    output = model(x)
    print(f"è¾“å‡ºå½¢çŠ¶: {output.shape}")  # [2, 100, 512]</code></pre>
                </div>
            </div>
        </div>
    </div>
    <!-- å›¾ç‰‡æ”¾å¤§å¼¹çª— -->
    <div id="imageModal" class="image-modal" onclick="closeImageModal()">
        <span class="image-modal-close" onclick="event.stopPropagation(); closeImageModal()">&times;</span>
        <img id="modalImage" class="image-modal-content" src="" alt="">
        <div id="modalCaption" class="image-modal-caption"></div>
    </div>
    <script>
        function openImageModal(img) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            const modalCaption = document.getElementById('modalCaption');
            modal.classList.add('active');
            modalImg.src = img.src;
            modalCaption.textContent = img.alt || '';
            modalImg.onclick = function(e) { e.stopPropagation(); };
        }
        function closeImageModal() {
            document.getElementById('imageModal').classList.remove('active');
        }
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeImageModal();
        });
    </script>
    <!-- å…¬å…±è„šæœ¬ -->
    <script src="../common/tech-document.js"></script>
</body>
</html>

