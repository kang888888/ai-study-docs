<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diffusion Model (æ‰©æ•£æ¨¡å‹) - æ¶æ„è¯¦è§£</title>
    <!-- MathJax for mathematical formulas -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- Prism.js for code highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    
    <!-- å…¬å…±æ ·å¼ -->
    <link rel="stylesheet" href="../common/styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Diffusion Model (æ‰©æ•£æ¨¡å‹)</h1>
            <p>å½“å‰æœ€å…ˆè¿›çš„ç”Ÿæˆæ¨¡å‹</p>
        </div>
        <div class="content">
            
            <div class="section">
                <h2>ğŸ“– æ ¸å¿ƒæ¦‚å¿µ</h2>
                <div class="desc-box">
                    <p>é€šè¿‡æ¨¡æ‹Ÿæ•°æ®é€æ¸æ·»åŠ å™ªå£°å˜æˆçº¯å™ªå£°çš„å‰å‘æ‰©æ•£è¿‡ç¨‹ï¼Œå¹¶è®­ç»ƒç¥ç»ç½‘ç»œå­¦ä¹ åå‘å»å™ªè¿‡ç¨‹ã€‚æ˜¯å½“å‰ç”Ÿæˆè´¨é‡æœ€é«˜ã€è®­ç»ƒæœ€ç¨³å®šçš„ç”Ÿæˆæ¨¡å‹ã€‚</p>
                </div>
            </div>
            <div class="section features">
                <h2>ğŸŒŸ æ ¸å¿ƒç‰¹ç‚¹</h2>
                <ul>
                    <li>å‰å‘æ‰©æ•£ï¼šé€æ­¥å‘æ•°æ®æ·»åŠ é«˜æ–¯å™ªå£°ï¼ŒTæ­¥åå˜æˆçº¯å™ªå£°</li>
                    <li>åå‘å»å™ªï¼šè®­ç»ƒU-Netç½‘ç»œé¢„æµ‹æ¯ä¸€æ­¥çš„å™ªå£°ï¼Œé€æ­¥æ¢å¤æ•°æ®</li>
                    <li>ç”Ÿæˆè´¨é‡æé«˜ï¼šç»†èŠ‚ä¸°å¯Œï¼Œè¿œè¶…GANå’ŒVAE</li>
                    <li>è®­ç»ƒç¨³å®šï¼šä¸åƒGANéœ€è¦å¹³è¡¡ç”Ÿæˆå™¨å’Œåˆ¤åˆ«å™¨</li>
                    <li>æ½œåœ¨æ‰©æ•£ï¼ˆLDMï¼‰ï¼šåœ¨æ½œåœ¨ç©ºé—´è¿›è¡Œæ‰©æ•£ï¼Œå¤§å¹…é™ä½è®¡ç®—æˆæœ¬</li>
                </ul>
            </div>
            <div class="section">
                <h2>âš™ï¸ å…³é”®æŠ€æœ¯</h2>
                <div class="tech-box"><p><strong>DDPMã€DDIMåŠ é€Ÿé‡‡æ ·ã€Classifier-Free Guidanceã€U-Netå»å™ªç½‘ç»œã€å™ªå£°è°ƒåº¦ï¼ˆNoise Scheduleï¼‰</strong></p></div>
            </div>
            <div class="section">
                <h2>ğŸš€ åº”ç”¨åœºæ™¯</h2>
                <div class="app-box"><p>æ–‡ç”Ÿå›¾ï¼ˆStable Diffusionã€DALL-E 2ï¼‰ã€å›¾åƒç¼–è¾‘ã€è§†é¢‘ç”Ÿæˆï¼ˆSoraï¼‰ã€éŸ³é¢‘ç”Ÿæˆ</p></div>
            </div>
            <div class="section">
                <h2>ğŸ“Š æ¶æ„å›¾è§£</h2>
                <div class="diagram-gallery">
                    <div class="diagram-item"><img src="æ‰©æ•£è¿‡ç¨‹.png" alt="æ‰©æ•£è¿‡ç¨‹" onclick="openImageModal(this)" onerror="this.parentElement.style.display='none'"><div class="caption">æ‰©æ•£è¿‡ç¨‹</div></div>
                    <div class="diagram-item"><img src="é‡‡æ ·è¿‡ç¨‹.png" alt="é‡‡æ ·è¿‡ç¨‹" onclick="openImageModal(this)" onerror="this.parentElement.style.display='none'"><div class="caption">é‡‡æ ·è¿‡ç¨‹</div></div>
                    <div class="diagram-item"><img src="å™ªå£°è°ƒåº¦.png" alt="å™ªå£°è°ƒåº¦" onclick="openImageModal(this)" onerror="this.parentElement.style.display='none'"><div class="caption">å™ªå£°è°ƒåº¦</div></div>
                </div>
            </div>

            <div class="section">
                <h2>ğŸ“ æ•°å­¦åŸç†</h2>
                <div class="math-box">
                    <h3>å‰å‘æ‰©æ•£è¿‡ç¨‹</h3>
                    <div class="math-formula">
                        <p>é€æ­¥å‘æ•°æ®æ·»åŠ é«˜æ–¯å™ªå£°ï¼š</p>
                        <p>$$q(x_t | x_{t-1}) = \mathcal{N}(x_t; \sqrt{1-\beta_t} x_{t-1}, \beta_t I)$$</p>
                        <p>å¯ä»¥ç®€åŒ–ä¸ºç›´æ¥ä» $x_0$ é‡‡æ ·ï¼š</p>
                        <p>$$q(x_t | x_0) = \mathcal{N}(x_t; \sqrt{\bar{\alpha}_t} x_0, (1-\bar{\alpha}_t) I)$$</p>
                        <p>å…¶ä¸­ $\bar{\alpha}_t = \prod_{s=1}^{t}(1-\beta_s)$</p>
                    </div>
                </div>
                <div class="math-box">
                    <h3>åå‘å»å™ªè¿‡ç¨‹</h3>
                    <div class="math-formula">
                        <p>å­¦ä¹ å»å™ªåˆ†å¸ƒï¼š</p>
                        <p>$$p_\theta(x_{t-1} | x_t) = \mathcal{N}(x_{t-1}; \mu_\theta(x_t, t), \Sigma_\theta(x_t, t))$$</p>
                        <p>è®­ç»ƒç›®æ ‡ï¼šé¢„æµ‹å™ªå£°</p>
                        <p>$$L = \mathbb{E}_{t,x_0,\epsilon} \left[||\epsilon - \epsilon_\theta(x_t, t)||^2\right]$$</p>
                        <p>å…¶ä¸­ $x_t = \sqrt{\bar{\alpha}_t} x_0 + \sqrt{1-\bar{\alpha}_t} \epsilon$</p>
                    </div>
                </div>
                <div class="math-box">
                    <h3>DDPM é‡‡æ ·</h3>
                    <div class="math-formula">
                        <p>ä»å™ªå£°é€æ­¥å»å™ªç”Ÿæˆï¼š</p>
                        <p>$$x_{t-1} = \frac{1}{\sqrt{\alpha_t}}\left(x_t - \frac{\beta_t}{\sqrt{1-\bar{\alpha}_t}} \epsilon_\theta(x_t, t)\right) + \sigma_t z$$</p>
                        <p>å…¶ä¸­ $z \sim \mathcal{N}(0, I)$ï¼Œ$\sigma_t$ æ˜¯å™ªå£°æ–¹å·®</p>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>ğŸ’» Python ä»£ç ç¤ºä¾‹</h2>
                <div class="code-box">
                    <h3>ä½¿ç”¨ PyTorch å®ç°ç®€å• Diffusion æ¨¡å‹</h3>
                    <pre><code class="language-python">import torch
import torch.nn as nn
import torch.nn.functional as F
import numpy as np

class DiffusionModel(nn.Module):
    """ç®€å•çš„ Diffusion æ¨¡å‹"""
    def __init__(self, timesteps=1000, beta_start=0.0001, beta_end=0.02):
        super(DiffusionModel, self).__init__()
        self.timesteps = timesteps
        
        # çº¿æ€§å™ªå£°è°ƒåº¦
        self.betas = torch.linspace(beta_start, beta_end, timesteps)
        self.alphas = 1.0 - self.betas
        self.alphas_cumprod = torch.cumprod(self.alphas, dim=0)
        self.alphas_cumprod_prev = F.pad(self.alphas_cumprod[:-1], (1, 0), value=1.0)
        
        # å»å™ªç½‘ç»œï¼ˆç®€åŒ–ç‰ˆï¼Œå®é™…ä½¿ç”¨U-Netï¼‰
        self.denoise_net = nn.Sequential(
            nn.Linear(784, 512),
            nn.ReLU(),
            nn.Linear(512, 512),
            nn.ReLU(),
            nn.Linear(512, 784)
        )
    
    def q_sample(self, x_start, t, noise=None):
        """å‰å‘æ‰©æ•£ï¼šæ·»åŠ å™ªå£°"""
        if noise is None:
            noise = torch.randn_like(x_start)
        
        sqrt_alphas_cumprod_t = torch.sqrt(self.alphas_cumprod[t])
        sqrt_one_minus_alphas_cumprod_t = torch.sqrt(1.0 - self.alphas_cumprod[t])
        
        return sqrt_alphas_cumprod_t * x_start + sqrt_one_minus_alphas_cumprod_t * noise
    
    def p_sample(self, x, t):
        """åå‘å»å™ªï¼šå•æ­¥é‡‡æ ·"""
        # é¢„æµ‹å™ªå£°
        predicted_noise = self.denoise_net(x)
        
        # è®¡ç®—å‡å€¼
        alpha_t = self.alphas[t]
        alpha_cumprod_t = self.alphas_cumprod[t]
        beta_t = self.betas[t]
        
        pred_x_start = (x - torch.sqrt(1.0 - alpha_cumprod_t) * predicted_noise) / torch.sqrt(alpha_cumprod_t)
        
        # è®¡ç®— x_{t-1}
        pred_x_prev = (1.0 / torch.sqrt(alpha_t)) * (x - (beta_t / torch.sqrt(1.0 - alpha_cumprod_t)) * predicted_noise)
        
        if t[0] > 0:
            noise = torch.randn_like(x)
            pred_x_prev += torch.sqrt(beta_t) * noise
        
        return pred_x_prev
    
    def p_sample_loop(self, shape):
        """å®Œæ•´é‡‡æ ·è¿‡ç¨‹"""
        device = next(self.parameters()).device
        b = shape[0]
        
        # ä»çº¯å™ªå£°å¼€å§‹
        img = torch.randn(shape, device=device)
        
        for i in reversed(range(0, self.timesteps)):
            t = torch.full((b,), i, device=device, dtype=torch.long)
            img = self.p_sample(img, t)
        
        return img
    
    def forward(self, x_start, t):
        """è®­ç»ƒæ—¶çš„å‰å‘ä¼ æ’­"""
        noise = torch.randn_like(x_start)
        x_noisy = self.q_sample(x_start, t, noise)
        predicted_noise = self.denoise_net(x_noisy)
        return predicted_noise

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    model = DiffusionModel(timesteps=1000)
    
    # æ¨¡æ‹Ÿè¾“å…¥ (batch_size=4, å±•å¹³çš„å›¾åƒ 28x28=784)
    x_start = torch.randn(4, 784)
    
    # éšæœºæ—¶é—´æ­¥
    t = torch.randint(0, 1000, (4,))
    
    # è®­ç»ƒï¼šé¢„æµ‹å™ªå£°
    predicted_noise = model(x_start, t)
    print(f"é¢„æµ‹å™ªå£°å½¢çŠ¶: {predicted_noise.shape}")  # [4, 784]
    
    # é‡‡æ ·ï¼šä»å™ªå£°ç”Ÿæˆ
    generated = model.p_sample_loop((4, 784))
    print(f"ç”Ÿæˆå›¾åƒå½¢çŠ¶: {generated.shape}")  # [4, 784]</code></pre>
                </div>
            </div>
        </div>
    </div>
    <!-- å›¾ç‰‡æ”¾å¤§å¼¹çª— -->
    <div id="imageModal" class="image-modal" onclick="closeImageModal()">
        <span class="image-modal-close" onclick="event.stopPropagation(); closeImageModal()">&times;</span>
        <img id="modalImage" class="image-modal-content" src="" alt="">
        <div id="modalCaption" class="image-modal-caption"></div>
    </div>
    <script>
        function openImageModal(img) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            const modalCaption = document.getElementById('modalCaption');
            modal.classList.add('active');
            modalImg.src = img.src;
            modalCaption.textContent = img.alt || '';
            modalImg.onclick = function(e) { e.stopPropagation(); };
        }
        function closeImageModal() {
            document.getElementById('imageModal').classList.remove('active');
        }
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeImageModal();
        });
    </script>
    <!-- å…¬å…±è„šæœ¬ -->
    <script src="../common/tech-document.js"></script>
</body>
</html>

