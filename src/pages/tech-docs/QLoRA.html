<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QLoRAï¼ˆQuantized LoRAï¼‰- æŠ€æœ¯è¯¦è§£</title>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    
    <!-- å…¬å…±æ ·å¼ -->
    <link rel="stylesheet" href="../common/styles.css">
</head>
<body>
    <div class="container">
        <h1>QLoRAï¼š4bit é‡åŒ– + LoRA çš„åŒé‡æ•ˆç‡æ–¹æ¡ˆ</h1>
        <p class="tagline">é€šè¿‡ NF4 éå¯¹ç§°é‡åŒ–ä¿å­˜ä¸»æ¨¡å‹ï¼Œåœ¨é‡åŒ–æƒé‡ä¸Šæ’å…¥ LoRA é€‚é…å™¨ï¼Œå®ç°â€œä½æ˜¾å­˜ + é«˜æ€§èƒ½â€çš„å¾®è°ƒèŒƒå¼ã€‚</p>

        <div class="meta-grid">
            <div class="meta-card">
                <h3>æ ¸å¿ƒäº®ç‚¹</h3>
                <p>4bit NormalFloat é‡åŒ– + åŒé˜¶æ®µå—ç¨€ç–ä¼˜åŒ– + åŠ¨æ€å¯è®­ç»ƒ LoRAï¼Œæ˜¾å­˜èŠ‚çœ 70%+</p>
            </div>
            <div class="meta-card">
                <h3>èµ„æºéœ€æ±‚</h3>
                <p>ä¸€å— 24GB GPU å³å¯å¾®è°ƒ 65B æ¨¡å‹ï¼ŒColab Pro äº¦å¯å®Œæˆ 33B å¾®è°ƒã€‚</p>
            </div>
            <div class="meta-card">
                <h3>å…¸å‹å·¥å…·é“¾</h3>
                <p>bitsandbytesã€PEFTã€TRLã€Accelerateã€Unsloth QLoRA presetã€‚</p>
            </div>
            <div class="meta-card">
                <h3>é€‚ç”¨ä»»åŠ¡</h3>
                <p>ä¸­å¤§å‹æŒ‡ä»¤å¾®è°ƒã€é¢†åŸŸå¯¹è¯ã€è½»é‡ RLHF SFT é˜¶æ®µã€ä»£ç /å¤šè¯­ç§é€‚é…ã€‚</p>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ”‘ æŠ€æœ¯è¦ç‚¹</h2>
            <ul>
                <li><strong>NF4 é‡åŒ–ï¼š</strong>ä½¿ç”¨æ­£æ€åˆ†å¸ƒæ„ŸçŸ¥çš„ 4bit éå¯¹ç§°æ ¼å¼ï¼Œä¿ç•™æƒé‡æ–¹å·®ä¸å‡å€¼ä¿¡æ¯ã€‚</li>
                <li><strong>åŒé‡é‡åŒ–å™¨ï¼š</strong>æŒ‰é€šé“é‡åŒ– + åŒé‡é‡åŒ–è¡¥å¿è¯¯å·®ï¼Œæ˜¾è‘—é™ä½é‡åŒ–å™ªå£°ã€‚</li>
                <li><strong>Paged Optimizerï¼š</strong>é€šè¿‡åˆ†å—åˆ†é¡µé¿å…æ˜¾å­˜ç¢ç‰‡ï¼Œè®©æå¤§ batch ä¹Ÿèƒ½è®­ç»ƒã€‚</li>
                <li><strong>LoRA on Quantized Baseï¼š</strong>å³ä¾¿åŸºç¡€æƒé‡é‡åŒ–ï¼Œä¹Ÿèƒ½å¯¹ LoRA é€‚é…å™¨è¿›è¡Œç²¾åº¦è¾ƒé«˜çš„ FP16/FP32 è®­ç»ƒã€‚</li>
            </ul>
        </div>

        <div class="section">
            <h2>ğŸ“Š æµç¨‹å›¾è§£</h2>
            <div class="diagram-gallery">
                <div class="diagram-item">
                    <img src="./assets/QLoRAæµç¨‹.png" alt="QLoRA æ•°æ®åˆ°è®­ç»ƒé“¾è·¯" onclick="openImageModal(this)" onerror="this.parentElement.style.display='none'">
                    <div class="caption">æ•°æ®åˆ°è®­ç»ƒé“¾è·¯</div>
                </div>
                <div class="diagram-item">
                    <img src="./assets/NF4é‡åŒ–ç¤ºæ„.png" alt="NF4 é‡åŒ–ç¤ºæ„" onclick="openImageModal(this)" onerror="this.parentElement.style.display='none'">
                    <div class="caption">NF4 é‡åŒ–ç¤ºæ„</div>
                </div>
                <div class="diagram-item">
                    <img src="./assets/LoRAåˆå¹¶.png" alt="LoRA é€‚é…å™¨åˆå¹¶" onclick="openImageModal(this)" onerror="this.parentElement.style.display='none'">
                    <div class="caption">LoRA é€‚é…å™¨åˆå¹¶</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ“ æ•°å­¦åŸç†</h2>
            <div class="math-box">
                <h3>NormalFloat4 é‡åŒ–</h3>
                <div class="math-formula">
                    <p>QLoRA å¯¹æƒé‡ $w$ è¿›è¡Œæ­£æ€åˆ†å¸ƒæ„ŸçŸ¥é‡åŒ–ï¼š</p>
                    <p>$$q = \operatorname{clip}\Bigg( \Big\lfloor \frac{w - \mu}{\sigma} \cdot \alpha \Big\rceil, -8, 7 \Bigg)$$</p>
                    <p>å…¶ä¸­ $\mu, \sigma$ æ¥è‡ªé«˜ç²¾åº¦ç»Ÿè®¡ï¼Œ$\alpha$ ä¸ºç¼©æ”¾å› å­ï¼Œæœ€ç»ˆå­˜å‚¨ä¸º 4bitã€‚</p>
                </div>
            </div>
            <div class="math-box">
                <h3>LoRA æ³¨å…¥</h3>
                <div class="math-formula">
                    <p>é‡åŒ–åä»å¯æ’å…¥ LoRAï¼š</p>
                    <p>$$y = (\operatorname{Dequant}(q) + \frac{\alpha}{r} BA ) x$$</p>
                    <p>å…¶ä¸­ $\operatorname{Dequant}(q)$ ä¸ºè§£é‡åŒ–æƒé‡ï¼Œ$BA$ ä»åœ¨ FP16/32 ç©ºé—´è®­ç»ƒã€‚</p>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ’» Python ä»£ç ç¤ºä¾‹</h2>
            <div class="code-box">
                <h3>ä½¿ç”¨ bitsandbytes + PEFT è¿›è¡Œ QLoRA</h3>
                <pre><code class="language-python">import torch
from transformers import AutoModelForCausalLM, AutoTokenizer, BitsAndBytesConfig
from peft import LoraConfig, get_peft_model

bnb_config = BitsAndBytesConfig(
    load_in_4bit=True,
    bnb_4bit_quant_type="nf4",
    bnb_4bit_compute_dtype=torch.bfloat16,
    bnb_4bit_use_double_quant=True
)

model = AutoModelForCausalLM.from_pretrained(
    "meta-llama/Llama-3-8b",
    quantization_config=bnb_config,
    device_map="auto"
)

tokenizer = AutoTokenizer.from_pretrained("meta-llama/Llama-3-8b", use_fast=False)

lora_config = LoraConfig(
    r=64,
    lora_alpha=64,
    target_modules=["q_proj", "k_proj", "v_proj", "o_proj"],
    lora_dropout=0.05,
    task_type="CAUSAL_LM"
)

model = get_peft_model(model, lora_config)
# åç»­å¯ä½¿ç”¨ TRL/Accelerate è¿›è¡Œ SFT æˆ–åå¥½è®­ç»ƒ
</code></pre>
            </div>
        </div>
    </div>

    <div id="imageModal" class="image-modal" onclick="closeImageModal()">
        <span class="image-modal-close" onclick="event.stopPropagation(); closeImageModal();">&times;</span>
        <img id="modalImage" class="image-modal-content" src="" alt="">
        <div id="modalCaption" class="image-modal-caption"></div>
    </div>

    <script>
        function openImageModal(img) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            const modalCaption = document.getElementById('modalCaption');
            modal.classList.add('active');
            modalImg.src = img.src;
            modalCaption.textContent = img.alt || '';
        }
        function closeImageModal() {
            document.getElementById('imageModal').classList.remove('active');
        }
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeImageModal();
        });
    </script>
    <!-- å…¬å…±è„šæœ¬ -->
    <script src="../common/tech-document.js"></script>
</body>
</html>
