<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SFTï¼ˆç›‘ç£å¾®è°ƒï¼‰- æŠ€æœ¯è¯¦è§£</title>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    
    <!-- å…¬å…±æ ·å¼ -->
    <link rel="stylesheet" href="../common/styles.css">
</head>
<body>
    <div class="container">
        <h1>Supervised Fine-Tuningï¼ˆSFTï¼‰ç›‘ç£å¾®è°ƒ</h1>
        <p class="tagline">ä»¥é«˜è´¨é‡æŒ‡ä»¤ç¤ºä¾‹é©±åŠ¨å¤§æ¨¡å‹å¯¹ç‰¹å®šä»»åŠ¡çš„ç²¾å‡†æŒæ¡ï¼Œæ˜¯æ‰€æœ‰å¾®è°ƒæµç¨‹çš„åŸºç¡€èµ·ç‚¹ã€‚</p>

        <div class="meta-grid">
            <div class="meta-card">
                <h3>æ ¸å¿ƒç›®æ ‡</h3>
                <p>é€šè¿‡æœ€å°åŒ–æ•™å¸ˆæ ‡ç­¾ä¸æ¨¡å‹è¾“å‡ºä¹‹é—´çš„äº¤å‰ç†µï¼Œå­¦ä¹ ä»»åŠ¡ç‰¹å®šçš„æ˜ å°„å…³ç³»ã€‚</p>
            </div>
            <div class="meta-card">
                <h3>å…¸å‹æ•°æ®æ ¼å¼</h3>
                <p>Alpaca / ShareGPT / Conversation JSONï¼Œå¼ºè°ƒ instruction-input-output ä¸‰å…ƒç»“æ„ã€‚</p>
            </div>
            <div class="meta-card">
                <h3>é€‚ç”¨åœºæ™¯</h3>
                <p>é€šç”¨æŒ‡ä»¤å¯¹è¯ã€é¢†åŸŸé—®ç­”ã€åˆ†ç±»ã€ä»£ç ç”Ÿæˆç­‰æ‰€æœ‰éœ€è¦æ˜¾å¼ç¤ºä¾‹çš„ä»»åŠ¡ã€‚</p>
            </div>
            <div class="meta-card">
                <h3>ä¼˜åŠ¿äº®ç‚¹</h3>
                <p>å®ç°ç®€å•ã€å¯æ§æ€§å¼ºã€æ˜“äºè¯„ä¼°ï¼Œæ˜¯åç»­åå¥½ä¼˜åŒ–ä¸å¯¹é½çš„è®­ç»ƒåŸºåº§ã€‚</p>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ“Œ æŠ€æœ¯è¦ç‚¹</h2>
            <ul>
                <li><strong>å¤šè½®æŒ‡ä»¤å»ºæ¨¡ï¼š</strong>ä½¿ç”¨å¯¹è¯å¼æ•°æ®ä¿æŒä¸Šä¸‹æ–‡ä¸€è‡´æ€§ï¼Œå……åˆ†è®­ç»ƒ system/human/assistant è§’è‰²ã€‚</li>
                <li><strong>æ¨¡æ¿åŒ–æ•°æ®ç”Ÿæˆï¼š</strong>å¯¹éå¯¹è¯ä»»åŠ¡æ„é€ æ ‡å‡† prompt æ¨¡æ¿ï¼Œä½¿æ¨¡å‹ç†è§£è¾“å…¥ä¸è¾“å‡ºçš„ç»“æ„æ€§å…³ç³»ã€‚</li>
                <li><strong>å­¦ä¹ ç‡ä¸æ¢¯åº¦ç­–ç•¥ï¼š</strong>é€šå¸¸ä½¿ç”¨ 5e-5 ~ 1e-5 çš„å°å­¦ä¹ ç‡ï¼Œé…åˆæ¢¯åº¦ç´¯ç§¯ä¸ mixed precision æ§åˆ¶æ˜¾å­˜ã€‚</li>
                <li><strong>è¯„ä¼°é—­ç¯ï¼š</strong>è‡ªåŠ¨æŒ‡æ ‡ + äººå·¥è¯„ä¼°åŒè½¨ï¼Œç¡®ä¿è¾“å‡ºçš„ç›¸å…³æ€§ã€å‡†ç¡®æ€§ä¸å®‰å…¨æ€§ã€‚</li>
            </ul>
        </div>

        <div class="section">
            <h2>ğŸ“Š æµç¨‹å›¾è§£</h2>
            <div class="diagram-gallery">
                <div class="diagram-item">
                    <img src="./assets/SFTæ•°æ®æµç¨‹.png" alt="SFT æ•°æ®æ¸…æ´—ä¸æ¨¡æ¿åŒ–" onclick="openImageModal(this)" onerror="this.parentElement.style.display='none'">
                    <div class="caption">SFT æ•°æ®æ¸…æ´—ä¸æ¨¡æ¿åŒ–</div>
                </div>
                <div class="diagram-item">
                    <img src="./assets/SFTè®­ç»ƒå¾ªç¯.png" alt="è®­ç»ƒå¾ªç¯" onclick="openImageModal(this)" onerror="this.parentElement.style.display='none'">
                    <div class="caption">è®­ç»ƒå¾ªç¯</div>
                </div>
                <div class="diagram-item">
                    <img src="./assets/SFTè¯„ä¼°æµç¨‹.png" alt="è¯„ä¼°é—­ç¯" onclick="openImageModal(this)" onerror="this.parentElement.style.display='none'">
                    <div class="caption">è¯„ä¼°é—­ç¯</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ“ æ•°å­¦åŸç†</h2>
            <div class="math-box">
                <h3>äº¤å‰ç†µç›®æ ‡</h3>
                <div class="math-formula">
                    <p>SFT é€šè¿‡æœ€å°åŒ–å‚è€ƒå“åº” $y$ çš„æ¡ä»¶æ¦‚ç‡è´Ÿå¯¹æ•°ä¼¼ç„¶ï¼š</p>
                    <p>$$\mathcal{L}_{\text{SFT}} = - \sum_{t=1}^{T} \log p_{\theta}(y_t \mid y_{<t}, x)$$</p>
                    <p>å…¶ä¸­ $x$ ä¸ºæŒ‡ä»¤/è¾“å…¥ï¼Œ$y$ ä¸ºç›®æ ‡è¾“å‡ºï¼Œ$p_{\theta}$ ç”±é¢„è®­ç»ƒå¤§æ¨¡å‹å‚æ•°åŒ–ã€‚</p>
                </div>
            </div>
            <div class="math-box">
                <h3>Label Smoothing</h3>
                <div class="math-formula">
                    <p>ä¸ºæå‡é²æ£’æ€§å¸¸å¼•å…¥æ ‡ç­¾å¹³æ»‘ï¼Œç›®æ ‡å˜ä¸ºï¼š</p>
                    <p>$$\tilde{y}_k = (1-\epsilon) \cdot \mathbb{1}[k = y] + \frac{\epsilon}{K}$$</p>
                    <p>ç¼“è§£è¿‡æ‹Ÿåˆå¹¶æå‡æ³›åŒ–èƒ½åŠ›ã€‚</p>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ’» Python ä»£ç ç¤ºä¾‹</h2>
            <div class="code-box">
                <h3>ä½¿ç”¨ Transformers è¿›è¡Œ SFT</h3>
                <pre><code class="language-python">from transformers import AutoTokenizer, AutoModelForCausalLM, TrainingArguments
from transformers import Trainer, DataCollatorForLanguageModeling
from datasets import load_dataset

model_name = "meta-llama/Llama-2-7b-hf"
tokenizer = AutoTokenizer.from_pretrained(model_name)
model = AutoModelForCausalLM.from_pretrained(
    model_name,
    load_in_8bit=True,
    device_map="auto"
)

# å‡è®¾æ•°æ®é›†å·²ç»æ ‡å‡†åŒ–ä¸º instruction/input/output å­—æ®µ
def format_sample(example):
    instruction = example["instruction"]
    input_text = example.get("input", "")
    output = example["output"]
    prompt = f"æŒ‡ä»¤ï¼š{instruction}\nè¾“å…¥ï¼š{input_text}\nå›ç­”ï¼š"
    return tokenizer(prompt + output, return_tensors="pt")

dataset = load_dataset("json", data_files="data/alpaca.json")

training_args = TrainingArguments(
    output_dir="sft-llama2",
    per_device_train_batch_size=1,
    gradient_accumulation_steps=8,
    learning_rate=2e-5,
    num_train_epochs=3,
    fp16=True,
    logging_steps=20,
    save_strategy="epoch"
)

data_collator = DataCollatorForLanguageModeling(tokenizer, mlm=False)

trainer = Trainer(
    model=model,
    args=training_args,
    train_dataset=dataset["train"],
    data_collator=data_collator
)

trainer.train()</code></pre>
            </div>
        </div>
    </div>

    <div id="imageModal" class="image-modal" onclick="closeImageModal()">
        <span class="image-modal-close" onclick="event.stopPropagation(); closeImageModal();">&times;</span>
        <img id="modalImage" class="image-modal-content" src="" alt="">
        <div id="modalCaption" class="image-modal-caption"></div>
    </div>

    <script>
        function openImageModal(img) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            const modalCaption = document.getElementById('modalCaption');
            modal.classList.add('active');
            modalImg.src = img.src;
            modalCaption.textContent = img.alt || '';
        }
        function closeImageModal() {
            document.getElementById('imageModal').classList.remove('active');
        }
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeImageModal();
        });
    </script>
    <!-- å…¬å…±è„šæœ¬ -->
    <script src="../common/tech-document.js"></script>
</body>
</html>
