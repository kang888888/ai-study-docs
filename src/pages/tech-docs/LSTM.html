<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LSTM (Long Short-Term Memory) é•¿çŸ­æœŸè®°å¿†ç½‘ç»œ - æ¶æ„è¯¦è§£</title>
    <!-- MathJax for mathematical formulas -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- Prism.js for code highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    
    <!-- å…¬å…±æ ·å¼ -->
    <link rel="stylesheet" href="../common/styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>LSTM (Long Short-Term Memory) é•¿çŸ­æœŸè®°å¿†ç½‘ç»œ</h1>
            <p>è§£å†³é•¿ç¨‹ä¾èµ–é—®é¢˜çš„RNNæ”¹è¿›ç‰ˆæœ¬</p>
        </div>
        <div class="content">
            
            <div class="section">
                <h2>ğŸ“– æ ¸å¿ƒæ¦‚å¿µ</h2>
                <div class="desc-box">
                    <p>RNNçš„æ”¹è¿›ç‰ˆæœ¬ï¼Œé€šè¿‡å¼•å…¥é—¨æ§æœºåˆ¶ï¼ˆé—å¿˜é—¨ã€è¾“å…¥é—¨ã€è¾“å‡ºé—¨ï¼‰å’Œç»†èƒçŠ¶æ€ï¼ˆCell Stateï¼‰ï¼Œæœ‰æ•ˆè§£å†³äº†é•¿ç¨‹ä¾èµ–é—®é¢˜å’Œæ¢¯åº¦æ¶ˆå¤±é—®é¢˜ã€‚</p>
                </div>
            </div>
            <div class="section features">
                <h2>ğŸŒŸ æ ¸å¿ƒç‰¹ç‚¹</h2>
                <ul>
                    <li>é—¨æ§æœºåˆ¶ï¼šé€šè¿‡ä¸‰ä¸ªé—¨ï¼ˆé—å¿˜ã€è¾“å…¥ã€è¾“å‡ºï¼‰æ§åˆ¶ä¿¡æ¯æµåŠ¨</li>
                    <li>ç»†èƒçŠ¶æ€ï¼šé•¿æœŸè®°å¿†é€šé“ï¼Œæ¢¯åº¦å¯ä»¥æ— æŸä¼ æ’­</li>
                    <li>é•¿ç¨‹ä¾èµ–ï¼šèƒ½å¤Ÿæ•æ‰åºåˆ—ä¸­ç›¸è·è¾ƒè¿œçš„ä¾èµ–å…³ç³»</li>
                    <li>å‚æ•°é‡è¾ƒå¤§ï¼šç›¸æ¯”RNNï¼Œå‚æ•°é‡å¢åŠ çº¦4å€</li>
                    <li>è®­ç»ƒç¨³å®šï¼šæ¢¯åº¦æµåŠ¨æ›´åŠ ç¨³å®š</li>
                </ul>
            </div>
            <div class="section">
                <h2>âš™ï¸ å…³é”®æŠ€æœ¯</h2>
                <div class="tech-box"><p><strong>é—¨æ§å•å…ƒã€ç»†èƒçŠ¶æ€ã€Peepholeè¿æ¥ï¼ˆå¯é€‰ï¼‰ã€é—å¿˜é—¨åç½®åˆå§‹åŒ–</strong></p></div>
            </div>
            <div class="section">
                <h2>ğŸš€ åº”ç”¨åœºæ™¯</h2>
                <div class="app-box"><p>æœºå™¨ç¿»è¯‘ã€æ–‡æœ¬ç”Ÿæˆã€è¯­éŸ³è¯†åˆ«ã€æ—¶é—´åºåˆ—é¢„æµ‹ã€æƒ…æ„Ÿåˆ†æ</p></div>
            </div>
            <div class="section">
                <h2>ğŸ“Š æ¶æ„å›¾è§£</h2>
                <div class="diagram-gallery">
                    <div class="diagram-item"><img src="LSTMå•å…ƒç»“æ„.png" alt="LSTMå•å…ƒç»“æ„" onclick="openImageModal(this)" onerror="this.parentElement.style.display='none'"><div class="caption">LSTMå•å…ƒç»“æ„</div></div>
                    <div class="diagram-item"><img src="LSTMåºåˆ—å±•å¼€.png" alt="LSTMåºåˆ—å±•å¼€" onclick="openImageModal(this)" onerror="this.parentElement.style.display='none'"><div class="caption">LSTMåºåˆ—å±•å¼€</div></div>
                    <div class="diagram-item"><img src="LSTMé—¨æ§æœºåˆ¶.png" alt="LSTMé—¨æ§æœºåˆ¶" onclick="openImageModal(this)" onerror="this.parentElement.style.display='none'"><div class="caption">LSTMé—¨æ§æœºåˆ¶</div></div>
                </div>
            </div>

            <div class="section">
                <h2>ğŸ“ æ•°å­¦åŸç†</h2>
                <div class="math-box">
                    <h3>LSTM æ ¸å¿ƒå…¬å¼</h3>
                    <div class="math-formula">
                        <p>åœ¨æ—¶é—´æ­¥ $t$ï¼ŒLSTM çš„è®¡ç®—è¿‡ç¨‹ï¼š</p>
                        <p><strong>é—å¿˜é—¨ï¼ˆForget Gateï¼‰ï¼š</strong></p>
                        <p>$$f_t = \sigma(W_f \cdot [h_{t-1}, x_t] + b_f)$$</p>
                        <p><strong>è¾“å…¥é—¨ï¼ˆInput Gateï¼‰ï¼š</strong></p>
                        <p>$$i_t = \sigma(W_i \cdot [h_{t-1}, x_t] + b_i)$$</p>
                        <p>$$\tilde{C}_t = \tanh(W_C \cdot [h_{t-1}, x_t] + b_C)$$</p>
                        <p><strong>ç»†èƒçŠ¶æ€æ›´æ–°ï¼š</strong></p>
                        <p>$$C_t = f_t * C_{t-1} + i_t * \tilde{C}_t$$</p>
                        <p><strong>è¾“å‡ºé—¨ï¼ˆOutput Gateï¼‰ï¼š</strong></p>
                        <p>$$o_t = \sigma(W_o \cdot [h_{t-1}, x_t] + b_o)$$</p>
                        <p>$$h_t = o_t * \tanh(C_t)$$</p>
                        <p>å…¶ä¸­ï¼š</p>
                        <ul style="list-style: none; padding-left: 20px;">
                            <li>$x_t$ æ˜¯å½“å‰æ—¶é—´æ­¥çš„è¾“å…¥</li>
                            <li>$h_{t-1}$ æ˜¯å‰ä¸€ä¸ªæ—¶é—´æ­¥çš„éšè—çŠ¶æ€</li>
                            <li>$C_t$ æ˜¯ç»†èƒçŠ¶æ€</li>
                            <li>$\sigma$ æ˜¯ sigmoid æ¿€æ´»å‡½æ•°</li>
                            <li>$*$ è¡¨ç¤ºé€å…ƒç´ ç›¸ä¹˜</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>ğŸ’» Python ä»£ç ç¤ºä¾‹</h2>
                <div class="code-box">
                    <h3>ä½¿ç”¨ PyTorch å®ç° LSTM</h3>
                    <pre><code class="language-python">import torch
import torch.nn as nn

class LSTMCell(nn.Module):
    """æ‰‹åŠ¨å®ç° LSTM å•å…ƒ"""
    def __init__(self, input_size, hidden_size):
        super(LSTMCell, self).__init__()
        self.hidden_size = hidden_size
        
        # é—å¿˜é—¨å‚æ•°
        self.W_f = nn.Linear(input_size + hidden_size, hidden_size)
        
        # è¾“å…¥é—¨å‚æ•°
        self.W_i = nn.Linear(input_size + hidden_size, hidden_size)
        self.W_C = nn.Linear(input_size + hidden_size, hidden_size)
        
        # è¾“å‡ºé—¨å‚æ•°
        self.W_o = nn.Linear(input_size + hidden_size, hidden_size)
    
    def forward(self, x, h_prev, C_prev):
        """
        å‰å‘ä¼ æ’­
        
        å‚æ•°:
            x: å½“å‰è¾“å…¥ (batch_size, input_size)
            h_prev: å‰ä¸€ä¸ªéšè—çŠ¶æ€ (batch_size, hidden_size)
            C_prev: å‰ä¸€ä¸ªç»†èƒçŠ¶æ€ (batch_size, hidden_size)
        """
        # æ‹¼æ¥è¾“å…¥å’Œéšè—çŠ¶æ€
        combined = torch.cat([x, h_prev], dim=1)
        
        # é—å¿˜é—¨
        f_t = torch.sigmoid(self.W_f(combined))
        
        # è¾“å…¥é—¨
        i_t = torch.sigmoid(self.W_i(combined))
        C_tilde = torch.tanh(self.W_C(combined))
        
        # æ›´æ–°ç»†èƒçŠ¶æ€
        C_t = f_t * C_prev + i_t * C_tilde
        
        # è¾“å‡ºé—¨
        o_t = torch.sigmoid(self.W_o(combined))
        
        # è®¡ç®—éšè—çŠ¶æ€
        h_t = o_t * torch.tanh(C_t)
        
        return h_t, C_t

class LSTM_Model(nn.Module):
    """ä½¿ç”¨ PyTorch å†…ç½® LSTM"""
    def __init__(self, input_size, hidden_size, num_layers, num_classes):
        super(LSTM_Model, self).__init__()
        self.hidden_size = hidden_size
        self.num_layers = num_layers
        
        # LSTM å±‚
        self.lstm = nn.LSTM(input_size, hidden_size, num_layers, 
                           batch_first=True, dropout=0.2)
        
        # å…¨è¿æ¥å±‚
        self.fc = nn.Linear(hidden_size, num_classes)
    
    def forward(self, x):
        # x shape: (batch_size, seq_length, input_size)
        # åˆå§‹åŒ–éšè—çŠ¶æ€å’Œç»†èƒçŠ¶æ€
        h0 = torch.zeros(self.num_layers, x.size(0), self.hidden_size).to(x.device)
        c0 = torch.zeros(self.num_layers, x.size(0), self.hidden_size).to(x.device)
        
        # LSTM å‰å‘ä¼ æ’­
        out, (h_n, c_n) = self.lstm(x, (h0, c0))
        
        # ä½¿ç”¨æœ€åä¸€ä¸ªæ—¶é—´æ­¥çš„è¾“å‡º
        out = self.fc(out[:, -1, :])
        
        return out

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    # ä½¿ç”¨ PyTorch å†…ç½® LSTM
    model = LSTM_Model(input_size=128, hidden_size=256, 
                      num_layers=2, num_classes=10)
    
    # æ¨¡æ‹Ÿè¾“å…¥ (batch_size=32, seq_length=50, input_size=128)
    x = torch.randn(32, 50, 128)
    
    # å‰å‘ä¼ æ’­
    output = model(x)
    print(f"è¾“å‡ºå½¢çŠ¶: {output.shape}")  # [32, 10]
    
    # æ‰‹åŠ¨å®ç° LSTM Cell
    lstm_cell = LSTMCell(input_size=128, hidden_size=256)
    
    # åˆå§‹åŒ–çŠ¶æ€
    h = torch.zeros(32, 256)
    C = torch.zeros(32, 256)
    
    # å¤„ç†åºåˆ—
    for t in range(50):
        x_t = torch.randn(32, 128)
        h, C = lstm_cell(x_t, h, C)
    
    print(f"æœ€ç»ˆéšè—çŠ¶æ€å½¢çŠ¶: {h.shape}")</code></pre>
                </div>
                <div class="code-box">
                    <h3>ä½¿ç”¨ NumPy æ‰‹åŠ¨å®ç° LSTM</h3>
                    <pre><code class="language-python">import numpy as np

class LSTM_Numpy:
    """ä½¿ç”¨ NumPy æ‰‹åŠ¨å®ç° LSTM"""
    def __init__(self, input_size, hidden_size):
        self.input_size = input_size
        self.hidden_size = hidden_size
        
        # åˆå§‹åŒ–æƒé‡çŸ©é˜µ
        # æƒé‡å½¢çŠ¶: (input_size + hidden_size, hidden_size)
        scale = 1.0 / np.sqrt(input_size + hidden_size)
        
        # é—å¿˜é—¨æƒé‡
        self.W_f = np.random.randn(input_size + hidden_size, hidden_size) * scale
        self.b_f = np.zeros((1, hidden_size))
        
        # è¾“å…¥é—¨æƒé‡
        self.W_i = np.random.randn(input_size + hidden_size, hidden_size) * scale
        self.b_i = np.zeros((1, hidden_size))
        
        # å€™é€‰å€¼æƒé‡
        self.W_C = np.random.randn(input_size + hidden_size, hidden_size) * scale
        self.b_C = np.zeros((1, hidden_size))
        
        # è¾“å‡ºé—¨æƒé‡
        self.W_o = np.random.randn(input_size + hidden_size, hidden_size) * scale
        self.b_o = np.zeros((1, hidden_size))
    
    def sigmoid(self, x):
        """Sigmoid æ¿€æ´»å‡½æ•°"""
        return 1 / (1 + np.exp(-np.clip(x, -250, 250)))
    
    def tanh(self, x):
        """Tanh æ¿€æ´»å‡½æ•°"""
        return np.tanh(x)
    
    def forward_step(self, x_t, h_prev, C_prev):
        """
        å•ä¸ªæ—¶é—´æ­¥çš„å‰å‘ä¼ æ’­
        
        å‚æ•°:
            x_t: å½“å‰è¾“å…¥ (batch_size, input_size)
            h_prev: å‰ä¸€ä¸ªéšè—çŠ¶æ€ (batch_size, hidden_size)
            C_prev: å‰ä¸€ä¸ªç»†èƒçŠ¶æ€ (batch_size, hidden_size)
        """
        # æ‹¼æ¥è¾“å…¥å’Œéšè—çŠ¶æ€
        combined = np.concatenate([x_t, h_prev], axis=1)
        
        # é—å¿˜é—¨
        f_t = self.sigmoid(np.dot(combined, self.W_f) + self.b_f)
        
        # è¾“å…¥é—¨
        i_t = self.sigmoid(np.dot(combined, self.W_i) + self.b_i)
        C_tilde = self.tanh(np.dot(combined, self.W_C) + self.b_C)
        
        # æ›´æ–°ç»†èƒçŠ¶æ€
        C_t = f_t * C_prev + i_t * C_tilde
        
        # è¾“å‡ºé—¨
        o_t = self.sigmoid(np.dot(combined, self.W_o) + self.b_o)
        
        # è®¡ç®—éšè—çŠ¶æ€
        h_t = o_t * self.tanh(C_t)
        
        return h_t, C_t
    
    def forward(self, X):
        """
        å¤„ç†æ•´ä¸ªåºåˆ—
        
        å‚æ•°:
            X: è¾“å…¥åºåˆ— (batch_size, seq_length, input_size)
        """
        batch_size, seq_length, _ = X.shape
        
        # åˆå§‹åŒ–çŠ¶æ€
        h = np.zeros((batch_size, self.hidden_size))
        C = np.zeros((batch_size, self.hidden_size))
        
        # å­˜å‚¨æ‰€æœ‰æ—¶é—´æ­¥çš„éšè—çŠ¶æ€
        hidden_states = []
        
        for t in range(seq_length):
            x_t = X[:, t, :]
            h, C = self.forward_step(x_t, h, C)
            hidden_states.append(h)
        
        # è¿”å›æ‰€æœ‰éšè—çŠ¶æ€å’Œæœ€ç»ˆçŠ¶æ€
        return np.array(hidden_states), h, C

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    # åˆ›å»º LSTM æ¨¡å‹
    lstm = LSTM_Numpy(input_size=10, hidden_size=20)
    
    # åˆ›å»ºè¾“å…¥åºåˆ— (batch_size=5, seq_length=8, input_size=10)
    X = np.random.randn(5, 8, 10)
    
    # å‰å‘ä¼ æ’­
    hidden_states, final_h, final_C = lstm.forward(X)
    
    print(f"éšè—çŠ¶æ€åºåˆ—å½¢çŠ¶: {hidden_states.shape}")  # (8, 5, 20)
    print(f"æœ€ç»ˆéšè—çŠ¶æ€å½¢çŠ¶: {final_h.shape}")  # (5, 20)
    print(f"æœ€ç»ˆç»†èƒçŠ¶æ€å½¢çŠ¶: {final_C.shape}")  # (5, 20)</code></pre>
                </div>
            </div>
        </div>
    </div>
    <!-- å›¾ç‰‡æ”¾å¤§å¼¹çª— -->
    <div id="imageModal" class="image-modal" onclick="closeImageModal()">
        <span class="image-modal-close" onclick="event.stopPropagation(); closeImageModal()">&times;</span>
        <img id="modalImage" class="image-modal-content" src="" alt="">
        <div id="modalCaption" class="image-modal-caption"></div>
    </div>
    <script>
        function openImageModal(img) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            const modalCaption = document.getElementById('modalCaption');
            modal.classList.add('active');
            modalImg.src = img.src;
            modalCaption.textContent = img.alt || '';
            modalImg.onclick = function(e) { e.stopPropagation(); };
        }
        function closeImageModal() {
            document.getElementById('imageModal').classList.remove('active');
        }
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeImageModal();
        });
    </script>
    <!-- å…¬å…±è„šæœ¬ -->
    <script src="../common/tech-document.js"></script>
</body>
</html>

