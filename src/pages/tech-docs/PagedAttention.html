<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PagedAttention ç®—æ³•è¯¦è§£</title>
    <script>
        window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']] }, options: { skipHtmlTags: ['script','noscript','style','textarea','pre','code'] } };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    
    <!-- å…¬å…±æ ·å¼ -->
    <link rel="stylesheet" href="../common/styles.css">
</head>
<body>
    <div class="container">
        <h1>PagedAttentionï¼šåˆ†é¡µå¼æ³¨æ„åŠ›ç¼“å­˜è°ƒåº¦</h1>
        <p class="tagline">é€šè¿‡è™šæ‹Ÿå†…å­˜æ€æƒ³ç®¡ç† KV Cacheï¼Œç”¨é¡µè¡¨æ˜ å°„æ›¿ä»£å¤åˆ¶ï¼Œè§£å†³å¤šä¼šè¯ã€é•¿ä¸Šä¸‹æ–‡å¸¦æ¥çš„å†…å­˜ç¢ç‰‡é—®é¢˜ã€‚</p>

        <div class="meta-grid">
            <div class="meta-card"><h3>çµæ„Ÿ</h3><p>å€Ÿé‰´æ“ä½œç³»ç»Ÿåˆ†é¡µï¼šKV ç¼“å­˜è¢«åˆ’åˆ†ä¸ºå›ºå®šå¤§å° pageï¼ŒæŒ‰éœ€åŠ è½½ã€‚</p></div>
            <div class="meta-card"><h3>ä¼˜åŠ¿</h3><p>é›¶å¤åˆ¶æ‰©å®¹ã€å¹¶å‘ç¨³å®šã€æ˜¾å­˜åˆ©ç”¨ç‡é«˜ã€‚</p></div>
            <div class="meta-card"><h3>å®ç°</h3><p>vLLMã€TensorRT-LLMã€LightLLM å‡å®ç°äº†è¯¥ç®—æ³•ã€‚</p></div>
            <div class="meta-card"><h3>å…³é”®ç»„ä»¶</h3><p>Page Tableã€Block Managerã€Allocatorã€Garbage Collectorã€‚</p></div>
        </div>

        <div class="section">
            <h2>ğŸ§  æ ¸å¿ƒæµç¨‹</h2>
            <ul>
                <li><strong>åˆ†å—ï¼š</strong>å°† KV Cache åˆ‡ä¸º 1~2MB pageï¼ˆåŒ…å«å¤šå±‚å¤šå¤´æ•°æ®ï¼‰ã€‚</li>
                <li><strong>é¡µè¡¨ï¼š</strong>æ¯ä¸ªè¯·æ±‚ç»´æŠ¤é€»è¾‘åºåˆ— â†’ ç‰©ç† page çš„æ˜ å°„ã€‚</li>
                <li><strong>å¤ç”¨ï¼š</strong>å®Œæˆè¾“å‡ºçš„è¯·æ±‚ç«‹å³é‡Šæ”¾ pageï¼Œä¾›æ–°è¯·æ±‚ä½¿ç”¨ã€‚</li>
                <li><strong>å¹¶è¡Œï¼š</strong>Prefill/Decode é˜¶æ®µå…±äº« allocatorï¼Œå‡å°‘åŒæ­¥ã€‚</li>
            </ul>
        </div>

        <div class="section">
            <h2>ğŸ“Š å›¾è§£</h2>
            <div class="diagram-gallery">
                <div class="diagram-item"><img src="./assets/PagedAttentionæ¦‚è§ˆ.png" alt="æ¦‚è§ˆ" onclick="openImageModal(this)" onerror="this.parentElement.style.display='none'"><div class="caption">æ¦‚è§ˆ</div></div>
                <div class="diagram-item"><img src="./assets/PageTable.png" alt="é¡µè¡¨ç»“æ„" onclick="openImageModal(this)" onerror="this.parentElement.style.display='none'"><div class="caption">é¡µè¡¨ç»“æ„</div></div>
                <div class="diagram-item"><img src="./assets/PagedAllocator.png" alt="åˆ†é…å™¨" onclick="openImageModal(this)" onerror="this.parentElement.style.display='none'"><div class="caption">åˆ†é…å™¨</div></div>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ“ æ•°å­¦/å¤æ‚åº¦</h2>
            <div class="math-box">
                <h3>å†…å­˜åˆ©ç”¨ç‡</h3>
                <div class="math-formula">
                    <p>$$U = 1 - \frac{P_{free}}{P_{total}}$$</p>
                    <p>PagedAttention é€šè¿‡å¿«é€Ÿå›æ”¶ä½¿ $P_{free}$ æŒç»­ä¿æŒåœ¨ä½æ°´å¹³ã€‚</p>
                </div>
            </div>
            <div class="math-box">
                <h3>page fault å¼€é”€</h3>
                <div class="math-formula">
                    <p>$$T = T_{hit} + p_{fault} (T_{alloc} + T_{init})$$</p>
                    <p>ç®—æ³•ç›®æ ‡æ˜¯é™ä½ $p_{fault}$ å¹¶ä¼˜åŒ– $T_{alloc}$ã€‚</p>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ’» ä¼ªä»£ç </h2>
            <div class="code-box">
<pre><code class="language-python">def allocate_pages(request_id, needed_pages):
    pages = []
    for _ in range(needed_pages):
        page = free_list.pop() if free_list else cuda_malloc(page_size)
        pages.append(page)
    page_table[request_id].extend(pages)
    return pages

# è§£ç é˜¶æ®µè®¿é—®
for token in batch:
    pages = page_table[token.req]
    kv_ptrs = gather_kv(pages, token.position)
    attention_step(kv_ptrs, token)
</code></pre>
            </div>
        </div>
    </div>

    <div id="imageModal" class="image-modal" onclick="closeImageModal()">
        <span class="image-modal-close" onclick="event.stopPropagation(); closeImageModal();">&times;</span>
        <img id="modalImage" class="image-modal-content" src="" alt="">
        <div id="modalCaption" class="image-modal-caption"></div>
    </div>

    <script>
        function openImageModal(img){const modal=document.getElementById('imageModal');modal.classList.add('active');document.getElementById('modalImage').src=img.src;document.getElementById('modalCaption').textContent=img.alt||'';}
        function closeImageModal(){document.getElementById('imageModal').classList.remove('active');}
        document.addEventListener('keydown',e=>{if(e.key==='Escape')closeImageModal();});
    </script>
    <!-- å…¬å…±è„šæœ¬ -->
    <script src="../common/tech-document.js"></script>
</body>
</html>
