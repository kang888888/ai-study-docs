{
  "title": "Supervised Fine-Tuningï¼ˆSFTï¼‰ç›‘ç£å¾®è°ƒ",
  "subtitle": "ä»¥é«˜è´¨é‡æŒ‡ä»¤ç¤ºä¾‹é©±åŠ¨å¤§æ¨¡å‹å¯¹ç‰¹å®šä»»åŠ¡çš„ç²¾å‡†æŒæ¡ï¼Œæ˜¯æ‰€æœ‰å¾®è°ƒæµç¨‹çš„åŸºç¡€èµ·ç‚¹ã€‚",
  "content": [
    {
      "type": "section",
      "title": "ğŸ“Š æµç¨‹å›¾è§£",
      "content": [
        {
          "type": "diagram-gallery",
          "images": [
            {
              "type": "svg-d3",
              "component": "GenericDiagram",
              "caption": "SFT æ•°æ®æ¸…æ´—ä¸æ¨¡æ¿åŒ–",
              "width": 1000,
              "height": 800,
              "interactive": true,
              "props": {
                "type": "flow",
                "title": "SFT æ•°æ®æ¸…æ´—ä¸æ¨¡æ¿åŒ–"
              }
            },
            {
              "type": "svg-d3",
              "component": "GenericDiagram",
              "caption": "è®­ç»ƒå¾ªç¯",
              "width": 1000,
              "height": 800,
              "interactive": true,
              "props": {
                "type": "flow",
                "title": "è®­ç»ƒå¾ªç¯"
              }
            },
            {
              "type": "svg-d3",
              "component": "GenericDiagram",
              "caption": "è¯„ä¼°é—­ç¯",
              "width": 1000,
              "height": 800,
              "interactive": true,
              "props": {
                "type": "flow",
                "title": "è¯„ä¼°é—­ç¯"
              }
            }
          ]
        }
      ]
    },
    {
      "type": "section",
      "title": "ğŸ“ æ•°å­¦åŸç†",
      "content": [
        {
          "type": "math-box",
          "title": "äº¤å‰ç†µç›®æ ‡",
          "formulas": [
            {
              "text": "SFT é€šè¿‡æœ€å°åŒ–å‚è€ƒå“åº” $y$ çš„æ¡ä»¶æ¦‚ç‡è´Ÿå¯¹æ•°ä¼¼ç„¶ï¼š",
              "inline": "y"
            },
            {
              "display": "\\mathcal{L}_{\\text{SFT}} = - \\sum_{t=1}^{T} \\log p_{\\theta}(y_t \\mid y_{<t}, x)"
            },
            {
              "text": "å…¶ä¸­ $x$ ä¸ºæŒ‡ä»¤/è¾“å…¥ï¼Œ$y$ ä¸ºç›®æ ‡è¾“å‡ºï¼Œ$p_{\\theta}$ ç”±é¢„è®­ç»ƒå¤§æ¨¡å‹å‚æ•°åŒ–ã€‚",
              "inline": "x"
            }
          ]
        },
        {
          "type": "math-box",
          "title": "Label Smoothing",
          "formulas": [
            {
              "text": "ä¸ºæå‡é²æ£’æ€§å¸¸å¼•å…¥æ ‡ç­¾å¹³æ»‘ï¼Œç›®æ ‡å˜ä¸ºï¼š"
            },
            {
              "display": "\\tilde{y}_k = (1-\\epsilon) \\cdot \\mathbb{1}[k = y] + \\frac{\\epsilon}{K}"
            },
            {
              "text": "ç¼“è§£è¿‡æ‹Ÿåˆå¹¶æå‡æ³›åŒ–èƒ½åŠ›ã€‚"
            }
          ]
        }
      ]
    },
    {
      "type": "section",
      "title": "ğŸ’» Python ä»£ç ç¤ºä¾‹",
      "content": [
        {
          "type": "code-box",
          "title": "ä½¿ç”¨ Transformers è¿›è¡Œ SFT",
          "language": "python",
          "code": "from transformers import AutoTokenizer, AutoModelForCausalLM, TrainingArguments\nfrom transformers import Trainer, DataCollatorForLanguageModeling\nfrom datasets import load_dataset\n\nmodel_name = \"meta-llama/Llama-2-7b-hf\"\ntokenizer = AutoTokenizer.from_pretrained(model_name)\nmodel = AutoModelForCausalLM.from_pretrained(\n    model_name,\n    load_in_8bit=True,\n    device_map=\"auto\"\n)\n\n# å‡è®¾æ•°æ®é›†å·²ç»æ ‡å‡†åŒ–ä¸º instruction/input/output å­—æ®µ\ndef format_sample(example):\n    instruction = example[\"instruction\"]\n    input_text = example.get(\"input\", \"\")\n    output = example[\"output\"]\n    prompt = f\"æŒ‡ä»¤ï¼š{instruction}\\nè¾“å…¥ï¼š{input_text}\\nå›ç­”ï¼š\"\n    return tokenizer(prompt + output, return_tensors=\"pt\")\n\ndataset = load_dataset(\"json\", data_files=\"data/alpaca.json\")\n\ntraining_args = TrainingArguments(\n    output_dir=\"sft-llama2\",\n    per_device_train_batch_size=1,\n    gradient_accumulation_steps=8,\n    learning_rate=2e-5,\n    num_train_epochs=3,\n    fp16=True,\n    logging_steps=20,\n    save_strategy=\"epoch\"\n)\n\ndata_collator = DataCollatorForLanguageModeling(tokenizer, mlm=False)\n\ntrainer = Trainer(\n    model=model,\n    args=training_args,\n    train_dataset=dataset[\"train\"],\n    data_collator=data_collator\n)\n\ntrainer.train()"
        }
      ]
    }
  ]
}