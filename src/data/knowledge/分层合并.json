{
  "title": "åˆ†å±‚åˆå¹¶ï¼ˆLayer-wise Mergeï¼‰",
  "subtitle": "å¯¹ä¸åŒå±‚ä½¿ç”¨ä¸åŒçš„åˆå¹¶ç­–ç•¥ï¼Œç²¾ç»†æ§åˆ¶åˆå¹¶è¿‡ç¨‹ï¼Œå®ç°æ›´çµæ´»çš„æ¨¡å‹èåˆã€‚",
  "content": [
    {
      "type": "section",
      "title": "ğŸ“– æ ¸å¿ƒæ¦‚å¿µ",
      "content": [
        {
          "type": "desc-box",
          "content": [
            "åˆ†å±‚åˆå¹¶æ˜¯ä¸€ç§ç²¾ç»†åŒ–çš„æ¨¡å‹åˆå¹¶æ–¹æ³•ï¼Œå®ƒå…è®¸å¯¹ä¸åŒå±‚ä½¿ç”¨ä¸åŒçš„åˆå¹¶ç­–ç•¥ã€‚è¿™ç§æ–¹æ³•è®¤è¯†åˆ°ä¸åŒå±‚åœ¨æ¨¡å‹ä¸­çš„ä½œç”¨ä¸åŒï¼Œå› æ­¤å¯ä»¥å¯¹ä¸åŒå±‚é‡‡ç”¨ä¸åŒçš„æƒé‡æˆ–åˆå¹¶æ–¹æ³•ï¼Œå®ç°æ›´ç²¾ç»†çš„æ§åˆ¶å’Œæ›´å¥½çš„åˆå¹¶æ•ˆæœã€‚"
          ]
        }
      ]
    },
    {
      "type": "section",
      "title": "ğŸ“Š æ¶æ„å›¾è§£",
      "content": [
        {
          "type": "diagram-gallery",
          "images": [
            {
              "type": "svg-d3",
              "component": "GenericDiagram",
              "caption": "åˆ†å±‚åˆå¹¶ç­–ç•¥",
              "width": 1000,
              "height": 800,
              "interactive": true,
              "props": {
                "type": "architecture",
                "title": "åˆ†å±‚åˆå¹¶ç­–ç•¥",
                "data": null
              }
            },
            {
              "type": "svg-d3",
              "component": "GenericDiagram",
              "caption": "ä¸åŒå±‚çš„æƒé‡åˆ†é…",
              "width": 1000,
              "height": 800,
              "interactive": true,
              "props": {
                "type": "flow",
                "title": "ä¸åŒå±‚çš„æƒé‡åˆ†é…",
                "data": null
              }
            },
            {
              "type": "svg-d3",
              "component": "GenericDiagram",
              "caption": "åˆå¹¶æ•ˆæœå¯¹æ¯”",
              "width": 1000,
              "height": 800,
              "interactive": true,
              "props": {
                "type": "comparison",
                "title": "åˆå¹¶æ•ˆæœå¯¹æ¯”",
                "data": null
              }
            }
          ]
        }
      ]
    },
    {
      "type": "section",
      "title": "ğŸŒŸ æ ¸å¿ƒç‰¹ç‚¹",
      "content": [
        {
          "type": "features",
          "items": [
            "ç²¾ç»†æ§åˆ¶ï¼šå¯ä»¥å¯¹æ¯ä¸€å±‚ä½¿ç”¨ä¸åŒçš„åˆå¹¶ç­–ç•¥",
            "çµæ´»æ€§å¼ºï¼šæ”¯æŒä¸åŒå±‚ä½¿ç”¨ä¸åŒçš„æƒé‡æˆ–æ–¹æ³•",
            "æ€§èƒ½ä¼˜åŒ–ï¼šé€šè¿‡ç²¾ç»†è°ƒæ•´å¯ä»¥è·å¾—æ›´å¥½çš„åˆå¹¶æ•ˆæœ",
            "å±‚æ¬¡æ„ŸçŸ¥ï¼šè€ƒè™‘ä¸åŒå±‚åœ¨æ¨¡å‹ä¸­çš„ä¸åŒä½œç”¨",
            "ç­–ç•¥å¤šæ ·ï¼šæ”¯æŒåŠ æƒå¹³å‡ã€æœ€å¤§å€¼ã€æœ€å°å€¼ç­‰å¤šç§ç­–ç•¥",
            "é€‚åº”æ€§å¼ºï¼šå¯ä»¥æ ¹æ®æ¨¡å‹ç‰¹ç‚¹é€‰æ‹©æœ€é€‚åˆçš„åˆå¹¶ç­–ç•¥"
          ]
        }
      ]
    },
    {
      "type": "section",
      "title": "ğŸ“ æ•°å­¦åŸç†",
      "content": [
        {
          "type": "math-box",
          "title": "åˆ†å±‚åˆå¹¶å…¬å¼",
          "formulas": [
            {
              "display": "\\theta_{merged}^{(l)} = f_l(\\theta_1^{(l)}, \\theta_2^{(l)}, \\ldots, \\theta_n^{(l)})"
            },
            {
              "text": "å¯¹æ¯ä¸€å±‚ $l$ ä½¿ç”¨ä¸åŒçš„åˆå¹¶å‡½æ•° $f_l$ï¼Œå¯ä»¥æ˜¯åŠ æƒå¹³å‡ã€æœ€å¤§å€¼ã€æœ€å°å€¼æˆ–å…¶ä»–ç­–ç•¥ã€‚",
              "inline": "f_l"
            }
          ]
        },
        {
          "type": "math-box",
          "title": "åˆ†å±‚åŠ æƒå¹³å‡",
          "formulas": [
            {
              "display": "\\theta_{merged}^{(l)} = \\sum_{i=1}^{n} w_i^{(l)} \\theta_i^{(l)}"
            },
            {
              "text": "æ¯ä¸€å±‚ $l$ å¯ä»¥ä½¿ç”¨ä¸åŒçš„æƒé‡ $w_i^{(l)}$ï¼Œæ€»å’Œä¸º1ã€‚",
              "inline": "w_i^{(l)}"
            }
          ]
        },
        {
          "type": "math-box",
          "title": "æ··åˆç­–ç•¥",
          "formulas": [
            {
              "text": "å¯ä»¥å¯¹ä¸åŒå±‚ä½¿ç”¨ä¸åŒç­–ç•¥ï¼š"
            },
            {
              "display": "f_l = \\begin{cases} \\text{åŠ æƒå¹³å‡} & \\text{å¯¹äºåµŒå…¥å±‚} \\\\ \\text{æœ€å¤§å€¼} & \\text{å¯¹äºæ³¨æ„åŠ›å±‚} \\\\ \\text{æœ€å°å€¼} & \\text{å¯¹äºè¾“å‡ºå±‚} \\end{cases}"
            },
            {
              "text": "æ ¹æ®å±‚çš„ç‰¹æ€§é€‰æ‹©æœ€é€‚åˆçš„åˆå¹¶ç­–ç•¥ã€‚"
            }
          ]
        }
      ]
    },
    {
      "type": "section",
      "title": "ğŸ’» Python ä»£ç ç¤ºä¾‹",
      "content": [
        {
          "type": "code-box",
          "title": "åˆ†å±‚åˆå¹¶å®ç°",
          "language": "python",
          "code": "import torch\nfrom transformers import AutoModelForCausalLM\n\n# åŠ è½½æ¨¡å‹\nmodel1 = AutoModelForCausalLM.from_pretrained(\"model1-path\")\nmodel2 = AutoModelForCausalLM.from_pretrained(\"model2-path\")\n\n# å®šä¹‰åˆ†å±‚æƒé‡ç­–ç•¥\nlayer_weights = {\n    \"embeddings\": [0.6, 0.4],  # åµŒå…¥å±‚æƒé‡\n    \"attention\": [0.5, 0.5],   # æ³¨æ„åŠ›å±‚æƒé‡\n    \"feedforward\": [0.4, 0.6], # å‰é¦ˆå±‚æƒé‡\n    \"output\": [0.5, 0.5]        # è¾“å‡ºå±‚æƒé‡\n}\n\n# æ‰§è¡Œåˆ†å±‚åˆå¹¶\nmerged_state_dict = {}\nfor key in model1.state_dict():\n    # æ ¹æ®å±‚ç±»å‹é€‰æ‹©æƒé‡\n    if \"embed\" in key:\n        weights = layer_weights[\"embeddings\"]\n    elif \"attention\" in key:\n        weights = layer_weights[\"attention\"]\n    elif \"feedforward\" in key or \"mlp\" in key:\n        weights = layer_weights[\"feedforward\"]\n    elif \"lm_head\" in key or \"output\" in key:\n        weights = layer_weights[\"output\"]\n    else:\n        weights = [0.5, 0.5]  # é»˜è®¤æƒé‡\n    \n    merged_state_dict[key] = (\n        weights[0] * model1.state_dict()[key] +\n        weights[1] * model2.state_dict()[key]\n    )\n\n# åˆ›å»ºåˆå¹¶åçš„æ¨¡å‹\nmerged_model = AutoModelForCausalLM.from_pretrained(\"model1-path\")\nmerged_model.load_state_dict(merged_state_dict)\nmerged_model.save_pretrained(\"./merged_model\")"
        },
        {
          "type": "code-box",
          "title": "ä½¿ç”¨MergeKitè¿›è¡Œåˆ†å±‚åˆå¹¶",
          "language": "python",
          "code": "from mergekit import MergeKit\n\n# é…ç½®åˆ†å±‚åˆå¹¶\nmerge_config = {\n    \"models\": [\n        {\"model\": \"model1-path\", \"weight\": 0.5},\n        {\"model\": \"model2-path\", \"weight\": 0.5}\n    ],\n    \"merge_method\": \"layer_wise\",\n    \"layer_strategy\": {\n        \"embeddings\": \"weighted_average\",\n        \"attention\": \"max\",\n        \"feedforward\": \"weighted_average\",\n        \"output\": \"weighted_average\"\n    },\n    \"output_path\": \"./merged_model\"\n}\n\n# æ‰§è¡Œåˆå¹¶\nmerger = MergeKit()\nmerged_model = merger.merge(merge_config)\nprint(\"åˆ†å±‚åˆå¹¶å®Œæˆï¼\")"
        }
      ]
    },
    {
      "type": "section",
      "title": "ğŸš€ åº”ç”¨åœºæ™¯",
      "content": [
        {
          "type": "app-box",
          "content": "ç²¾ç»†æ§åˆ¶ï¼šéœ€è¦å¯¹ä¸åŒå±‚è¿›è¡Œç²¾ç»†æ§åˆ¶çš„åœºæ™¯ã€‚æ€§èƒ½ä¼˜åŒ–ï¼šé€šè¿‡åˆ†å±‚ç­–ç•¥ä¼˜åŒ–åˆå¹¶æ•ˆæœã€‚æ··åˆæ¶æ„ï¼šåˆå¹¶å…·æœ‰ä¸åŒæ¶æ„ç‰¹ç‚¹çš„æ¨¡å‹ã€‚ä»»åŠ¡ç‰¹åŒ–ï¼šå¯¹ä¸åŒå±‚é‡‡ç”¨ä¸åŒç­–ç•¥ä»¥é€‚åº”ç‰¹å®šä»»åŠ¡ã€‚"
        }
      ]
    },
    {
      "type": "section",
      "title": "âš ï¸ æ³¨æ„äº‹é¡¹",
      "content": [
        {
          "type": "features",
          "items": [
            "ç­–ç•¥é€‰æ‹©ï¼šéœ€è¦æ ¹æ®æ¨¡å‹ç‰¹ç‚¹é€‰æ‹©åˆé€‚çš„åˆå¹¶ç­–ç•¥",
            "æƒé‡è°ƒä¼˜ï¼šä¸åŒå±‚çš„æƒé‡éœ€è¦ä»”ç»†è°ƒä¼˜",
            "è®¡ç®—å¤æ‚åº¦ï¼šåˆ†å±‚åˆå¹¶çš„è®¡ç®—å¤æ‚åº¦ç›¸å¯¹è¾ƒé«˜",
            "å®éªŒéªŒè¯ï¼šéœ€è¦é€šè¿‡å®éªŒç¡®å®šæœ€ä½³çš„åˆ†å±‚ç­–ç•¥",
            "æ¶æ„å…¼å®¹ï¼šç¡®ä¿å„æ¨¡å‹çš„å±‚ç»“æ„å…¼å®¹"
          ]
        }
      ]
    }
  ]
}
