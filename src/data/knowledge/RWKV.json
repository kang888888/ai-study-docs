{
  "title": "RWKV (Receptance Weighted Key Value)",
  "subtitle": "ç»“åˆTransformerå’ŒRNNä¼˜åŠ¿çš„åˆ›æ–°æ¶æ„",
  "content": [
    {
      "type": "section",
      "title": "ğŸ“– æ ¸å¿ƒæ¦‚å¿µ",
      "content": [
        {
          "type": "desc-box",
          "content": [
            "ä¸€ç§åˆ›æ–°æ¶æ„ï¼Œç»“åˆäº†Transformerçš„å¹¶è¡Œè®­ç»ƒèƒ½åŠ›å’ŒRNNçš„é«˜æ•ˆæ¨ç†ç‰¹æ€§ã€‚é€šè¿‡çº¿æ€§æ³¨æ„åŠ›æœºåˆ¶ï¼Œå®ç°O(L)å¤æ‚åº¦çš„åŒæ—¶ä¿æŒæ¥è¿‘Transformerçš„æ€§èƒ½ã€‚"
          ]
        }
      ]
    },
    {
      "type": "section",
      "title": "ğŸŒŸ æ ¸å¿ƒç‰¹ç‚¹",
      "content": [
        {
          "type": "features",
          "items": [
            "çº¿æ€§Attentionï¼šå°†æ ‡å‡†Attentionæ”¹é€ ä¸ºçº¿æ€§é€’å½’å½¢å¼",
            "åŒé‡æ¨¡å¼ï¼šè®­ç»ƒæ—¶å¹¶è¡Œï¼ˆç±»ä¼¼Transformerï¼‰ï¼Œæ¨ç†æ—¶é€’å½’ï¼ˆç±»ä¼¼RNNï¼‰",
            "æ˜¾å­˜é«˜æ•ˆï¼šæ¨ç†æ—¶æ˜¾å­˜å ç”¨O(1)ï¼Œæ— KV Cache",
            "æ— é™ä¸Šä¸‹æ–‡ï¼šç†è®ºä¸Šå¯ä»¥å¤„ç†æ— é™é•¿çš„åºåˆ—",
            "å¼€æºå‹å¥½ï¼šå®Œå…¨å¼€æºï¼Œç¤¾åŒºæ´»è·ƒ"
          ]
        }
      ]
    },
    {
      "type": "section",
      "title": "âš™ï¸ å…³é”®æŠ€æœ¯",
      "content": [
        {
          "type": "tech-box",
          "content": "Time-Mixingã€Channel-Mixingã€æŒ‡æ•°è¡°å‡æœºåˆ¶ã€å¹¶è¡Œå‰ç¼€å’Œç®—æ³•"
        }
      ]
    },
    {
      "type": "section",
      "title": "ğŸš€ åº”ç”¨åœºæ™¯",
      "content": [
        {
          "type": "app-box",
          "content": "é•¿æ–‡æœ¬ç”Ÿæˆã€å¯¹è¯ç³»ç»Ÿã€ä»£ç ç”Ÿæˆã€ä½èµ„æºåœºæ™¯éƒ¨ç½²"
        }
      ]
    },
    {
      "type": "section",
      "title": "ğŸ“Š æ¶æ„å›¾è§£",
      "content": [
        {
          "type": "diagram-gallery",
          "images": [
            {
              "type": "svg-d3",
              "component": "RWKVDiagram",
              "caption": "RWKVè¡°å‡å¯è§†åŒ–",
              "width": 1000,
              "height": 800,
              "interactive": true,
              "props": {
                "type": "architecture",
                "title": "RWKVè¡°å‡å¯è§†åŒ–"
              }
            },
            {
              "type": "svg-d3",
              "component": "RWKVDiagram",
              "caption": "RWKVç»„ä»¶è¯¦è§£",
              "width": 1000,
              "height": 800,
              "interactive": true,
              "props": {
                "type": "architecture",
                "title": "RWKVç»„ä»¶è¯¦è§£"
              }
            }
          ]
        }
      ]
    },
    {
      "type": "section",
      "title": "ğŸ“ æ•°å­¦åŸç†",
      "content": [
        {
          "type": "math-box",
          "title": "Time-Mixing",
          "formulas": [
            {
              "text": "RWKV çš„ Time-Mixing æœºåˆ¶ï¼š"
            },
            {
              "display": "r_t = W_r \\cdot x_t"
            },
            {
              "display": "k_t = W_k \\cdot x_t"
            },
            {
              "display": "v_t = W_v \\cdot x_t"
            },
            {
              "display": "o_t = \\sigma(r_t) \\odot \\frac{\\sum_{i=1}^{t} w_{t-i} \\cdot k_i \\odot v_i}{\\sum_{i=1}^{t} w_{t-i} \\cdot k_i}"
            },
            {
              "text": "å…¶ä¸­ $w_{t-i}$ æ˜¯æ—¶é—´è¡°å‡æƒé‡",
              "inline": "w_{t-i}"
            }
          ]
        },
        {
          "type": "math-box",
          "title": "æŒ‡æ•°è¡°å‡æœºåˆ¶",
          "formulas": [
            {
              "text": "ä½¿ç”¨æŒ‡æ•°è¡°å‡æ¨¡æ‹Ÿæ³¨æ„åŠ›ï¼š"
            },
            {
              "display": "w_{t-i} = e^{-\\alpha (t-i)}"
            },
            {
              "text": "å…¶ä¸­ $\\alpha$ æ˜¯å¯å­¦ä¹ çš„è¡°å‡å‚æ•°ï¼Œä½¿å¾—è·ç¦»è¶Šè¿œçš„ä¿¡æ¯æƒé‡è¶Šå°",
              "inline": "\\alpha"
            }
          ]
        }
      ]
    },
    {
      "type": "section",
      "title": "ğŸ’» Python ä»£ç ç¤ºä¾‹",
      "content": [
        {
          "type": "code-box",
          "title": "ä½¿ç”¨ rwkv åº“åŠ è½½ RWKV æ¨¡å‹",
          "language": "python",
          "code": "from rwkv.model import RWKV\nfrom rwkv.utils import PIPELINE, PIPELINE_ARGS\n\n# åŠ è½½æ¨¡å‹\nmodel = RWKV(model='./RWKV-4-Pile-430M.pth', strategy='cuda fp32')\npipeline = PIPELINE(model, \"20B_tokenizer.json\")\n\n# ç”Ÿæˆæ–‡æœ¬\ntext = \"The future of AI is\"\nargs = PIPELINE_ARGS(temperature=1.0, top_p=0.5)\n\noutput = pipeline.generate(text, token_count=100, args=args)\nprint(output)"
        },
        {
          "type": "code-box",
          "title": "æ‰‹åŠ¨å®ç°ç®€åŒ–ç‰ˆ RWKV Time-Mixing",
          "language": "python",
          "code": "import torch\nimport torch.nn as nn\nimport torch.nn.functional as F\n\nclass RWKVTimeMixing(nn.Module):\n    \"\"\"RWKV Time-Mixing å±‚ï¼ˆç®€åŒ–ç‰ˆï¼‰\"\"\"\n    def __init__(self, d_model):\n        super(RWKVTimeMixing, self).__init__()\n        self.d_model = d_model\n        \n        # Receptance, Key, Value\n        self.r = nn.Linear(d_model, d_model)\n        self.k = nn.Linear(d_model, d_model)\n        self.v = nn.Linear(d_model, d_model)\n        \n        # è¡°å‡å‚æ•°\n        self.decay = nn.Parameter(torch.ones(d_model))\n    \n    def forward(self, x):\n        \"\"\"\n        å‚æ•°:\n            x: [batch_size, seq_length, d_model]\n        è¿”å›:\n            output: [batch_size, seq_length, d_model]\n        \"\"\"\n        batch_size, seq_length, d_model = x.shape\n        \n        r = torch.sigmoid(self.r(x))\n        k = self.k(x)\n        v = self.v(x)\n        \n        # è®¡ç®—è¡°å‡æƒé‡\n        decay_weights = torch.exp(-self.decay.unsqueeze(0).unsqueeze(0) * \n                                  torch.arange(seq_length, device=x.device).float().unsqueeze(-1))\n        \n        # é€’å½’è®¡ç®—ï¼ˆç®€åŒ–ç‰ˆï¼‰\n        output = torch.zeros_like(x)\n        for t in range(seq_length):\n            # åŠ æƒèšåˆå†å²ä¿¡æ¯\n            weights = decay_weights[:t+1].flip(0)  # åè½¬ï¼Œæœ€è¿‘çš„æƒé‡æœ€å¤§\n            weighted_kv = (weights.unsqueeze(-1) * k[:, :t+1, :] * v[:, :t+1, :]).sum(dim=1)\n            weighted_k = (weights.unsqueeze(-1) * k[:, :t+1, :]).sum(dim=1)\n            \n            output[:, t, :] = r[:, t, :] * (weighted_kv / (weighted_k + 1e-8))\n        \n        return output\n\n# ä½¿ç”¨ç¤ºä¾‹\nif __name__ == \"__main__\":\n    model = RWKVTimeMixing(d_model=512)\n    x = torch.randn(2, 100, 512)\n    output = model(x)\n    print(f\"è¾“å‡ºå½¢çŠ¶: {output.shape}\")  # [2, 100, 512]"
        }
      ]
    }
  ]
}